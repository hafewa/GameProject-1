-- region *.lua
-- Date
-- 此文件由[BabeLua]插件自动生成
local class = require("common/middleclass")
local ui_fight = class("ui_fight", ui_session)
local StateMachine = require("framework/StateMachine")
local fsm = StateMachine.new()

function ui_fight.show_me()
    local sd = ui_session_data(ui_session_type.FIXED, ui_session_id.UI_fight)
    m_ui_manager:show_session(ui_fight(sd))
end

function ui_fight:initialize(session_data)
    ui_session.initialize(self, session_data)
    self.session_id = ui_session_id.UI_shopScene
end


function ui_fight:on_post_load()
    math.newrandomseed()
    local time_txt = self.transform:Find("Win/time_bg/txt"):GetComponent("UILabel")
    local t = TimeTicker()
    t:Start(5 * 60)
    t.OnTick = GameResFactory.Instance():getEDC2(function(go)
        local tempInt = math.ceil(t.OverTime)
        time_txt.text = string.format("%02d", math.modf(tempInt / 60)) .. ":" .. string.format("%02d", tempInt % 60)
    end)
    
    t.OnEnd = GameResFactory.Instance():getEDC2(function(go)
        time_txt.text = "00:00"
    end)
    
    local myBloodBar = self.transform:Find("Win/defence_widget1/hp_fg"):GetComponent("UISprite")
    --    myBloodBar.fillAmount = 0.5
    -- UI卡牌框数
    self.uiCardNum = 4
    -- UI技能框数
    self.uiSkillNum = 3
    -- 当前3d相机
    self.nowWorldCamera = GameObject.Find("/PTZCamera/SceneryCamera"):GetComponent(typeof(UnityEngine.Camera))
    -- 当前UI相机
    self.nowUICamera = GameObject.Find("/UIRoot/Camera_UI"):GetComponent(typeof(UnityEngine.Camera))
    -- DragDropRoot
    self.DragDropRoot = GameObject.Find("/UIRoot/DragDropRoot").transform
    -- 装载ui卡牌的panel
    self.currentCards_bg = self.transform:Find("Win/currentCards_bg")
    -- 下一张卡牌的UISprite
    self.nextCardSpr = self.transform:Find("Win/currentCards_bg/nextCard").gameObject:GetComponent(typeof(UISprite))
    --费barUISprite
    local feiBgTf = self.transform:Find("Win/currentCards_bg/feiBg")
    self.feiBarSpr = self.transform:Find("Win/currentCards_bg/feiBg/feiBar").gameObject:GetComponent(typeof(UISprite))
    --总费Label
    self.allFeiLabel = self.transform:Find("Win/currentCards_bg/feiBg/allFeiLabel").gameObject:GetComponent(typeof(UILabel))
    --当前费Label
    self.nowFeiLabel = self.transform:Find("Win/currentCards_bg/feiBg/nowFeiLabel").gameObject:GetComponent(typeof(UILabel))
    --总费
    self.allFei = 1000; self.allFeiLabel.text = self.allFei .. ""
    --当前费
    self.nowFei = 1000; self.nowFeiLabel.text = self.nowFei .. ""
    -- 拖动中的卡牌table
    self.onPressMyCardtb = {}
    -- 下方卡牌缩放间距
    self.onPressMyCardSpantb = {}
    -- 拖动中的卡牌模型table
    self.onPressArmytb = {}
    -- UI卡牌table
    self.nowMyCardtb = {}
    -- UI卡牌CDtable
    self.nowMyCardCDtbUISpritetb = {}
    -- UI技能table
    self.uiSkilltb = {}
    -- UI卡牌原始位置
    self.myCardConstPostb = {}
    -- 卡牌消耗费
    self.myCardCostFeitb = {100, 200, 300, 500}
    --费Bounds
    local feiUIWidget = feiBgTf.gameObject:GetComponent(typeof(UIWidget))
    feiBgTf.parent = self.DragDropRoot
    self.feiBounds = Bounds(Vector3(feiBgTf.localPosition.x, feiBgTf.localPosition.y, 0), Vector3(feiUIWidget.width, feiUIWidget.height, 0))
    feiBgTf.parent = self.currentCards_bg
    -- UIRoot的locationScale
    self.urlc = GameObject.Find("/UIRoot").transform.localScale.x
    
    -----------------------------------卡牌UI获取
    for var = 1, self.uiCardNum do
        local tf = self.transform:Find("Win/currentCards_bg/currentCard" .. var)
        self.nowMyCardtb[var] = tf
        self.myCardConstPostb[var] = tf.position
        --添加拖拽脚本
        tf.gameObject:AddComponent(typeof(UIDragObjectEX))
        local go = tf.gameObject
        self.nowMyCardCDtbUISpritetb[var] = tf:FindChild("CDBar").gameObject:GetComponent("UISprite")
        UIEventListener.Get(tf.gameObject).onPress = LuaHelper.BoolDelegate(function(go, args)
            if args then
                print("点击事件")
                -- 点击事件
                -- 把其他前置状态的牌归位
                for var2 = 1, self.uiCardNum do
                    -- 如果处于前置状态
                    if self.nowMyCardtb[var2].localPosition.y > 10 then
                        -- 如果卡牌没有点击中
                        if table.indexof(self.onPressMyCardtb, self.nowMyCardtb[var2]) == false then
                            -- 如果不是自己
                            if var ~= var2 then
                                TweenPosition.Begin(self.nowMyCardtb[var2].gameObject, Vector3.Distance(self.nowMyCardtb[var2].position, self.myCardConstPostb[var2]) / 2, self.myCardConstPostb[var2], true)
                            end
                        end
                    end
                end
                
                --计算下方卡牌缩放间距
                local tempInt = #self.onPressMyCardtb + 1
                if tf.localPosition.y < 20 then
                    self.onPressMyCardSpantb[tempInt] = 88
                else
                    self.onPressMyCardSpantb[tempInt] = 88 - 25
                end
                
                self.onPressMyCardtb[tempInt] = tf
                tf.parent = self.DragDropRoot
                --生成模型
                local ct = DP_FightPrefabManage.InstantiateAvatar(AvatarCM.CavalryHero_RH, false, 0, "xiahoudun", "xiahoudun", true)
                ct.transform.localScale = Vector3.zero
                ct:SetActive(true)
                self.onPressArmytb[tempInt] = ct.transform
            else --松开卡牌
                if self.nowFei >= self.myCardCostFeitb[var] and (tf.position.y > -1.16) and (tf.position.y < 0.9) then --拖到屏幕中
                    self:onUnPress(tf, var, 3)
                else
                    local cardBounds = Bounds(tf.localPosition, Vector3(self.nowMyCardSizetb.x, self.nowMyCardSizetb.y, 0) * tf.localScale.x)
                    if self.feiBounds:Intersects(cardBounds) then --回收卡
                        self:onUnPress(tf, var, 1)
                    else --拖回下方
                        self:onUnPress(tf, var, 0)
                    end
                end
            end
        end)
    end
    local cardWidget = self.nowMyCardtb[1].gameObject:GetComponent(typeof(UIWidget))
    -- UI卡牌Size
    self.nowMyCardSizetb = Vector2(cardWidget.width, cardWidget.height) / 8
    -----------------------------------技能UI获取
    for var = 1, self.uiSkillNum do
        local tf = self.transform:Find("Win/currentCards_bg/skill" .. var)
        self.uiSkilltb[var] = tf
        local go = tf.gameObject
        UIEventListener.Get(tf.gameObject).onPress = LuaHelper.BoolDelegate(function(go, args)
            if args then
                end
        end)
    end
    -----------------------------------单击屏幕出牌
    GameResFactory.Instance():TouchStartHandler2(function()
        self.lastMousePosition = Input.mousePosition
    end)
    GameResFactory.Instance():TouchUpHandler1(function()
        if self.lastMousePosition then --可能一瞬间会有1次以上的回调，保证只走一次逻辑
            local mp = Input.mousePosition
            if mp.y > 110 and mp.y < 608 then --下兵
                for var = 1, 4 do
                    if self.nowMyCardtb[var].localPosition.y > 20 and self.nowFei >= self.myCardCostFeitb[var] and Vector3.Distance(self.lastMousePosition, mp) < 20 then
                        self:onUnPress(self.nowMyCardtb[var], var, 4)
                        break
                    end
                end
            else
                local nP = self.nowUICamera:ScreenToWorldPoint(mp)
                nP.z = 0
                if self.feiBounds:Contains(nP / self.urlc) then --回收卡
                    for var = 1, 4 do
                        if self.nowMyCardtb[var].localPosition.y > 20 then
                            self:onUnPress(self.nowMyCardtb[var], var, 2)
                            break
                        end
                    end
                end
            end
        end
        self.lastMousePosition = nil
    end)
    
    -----------------------------------长按头像显示用户信息
    local delay1Ct = {}
    local userInfoBg = self.transform:Find("Win/userInfoBg")
    UIEventListener.Get(userInfoBg.gameObject).onPress = LuaHelper.BoolDelegate(function(go, args)
        if args then
            print("长按头像显示用户信息")
            userInfoBg.gameObject:SetActive(false)
        end
    end)
    for var = 1, 2 do
        UIEventListener.Get(self.transform:Find("Win/defence_widget" .. var .. "/bg2").gameObject).onPress = LuaHelper.BoolDelegate(function(go, args)
            if args then -- 开启协程
                delay1Ct[var] = coroutine.start(function()
                    coroutine.wait(1)
                    userInfoBg.localPosition = Vector3(-107 + (var - 1) * 240.8, 355, 0)
                    userInfoBg.gameObject:SetActive(true)
                end)
            else
                print("停止协程")
                coroutine.stop(delay1Ct[var])
            end
        
        end)
    end


end
-----------------------------------
--松开卡牌
function ui_fight:onUnPress(tf, var, isXiaBing)
    if isXiaBing > 0 then -- 下兵事件
        print("下兵事件")
        if isXiaBing > 2 then
            self.nowFei = self.nowFei - self.myCardCostFeitb[var]
            self.nowFeiLabel.text = self.nowFei .. ""
            if isXiaBing == 3 then --拖动下兵
                self:backCallback(tf)
            elseif isXiaBing == 4 then --点击下兵
                --生成模型
                local ct = DP_FightPrefabManage.InstantiateAvatar(AvatarCM.CavalryHero_RH, false, 0, "xiahoudun", "xiahoudun", true)
                ct:SetActive(true)
                ray = self.nowWorldCamera:ScreenPointToRay(Input.mousePosition)
                local isC, hit = UnityEngine.Physics.Raycast(ray, hit)
                if isC then
                    ct.transform.position = hit.point
                end
            end
        else
            print("回收卡")
            if (self.nowFei < self.allFei) == false then --如果满费则什么也不做
                return
            end
            self.nowFei = self.nowFei + self.myCardCostFeitb[var]
            if isXiaBing == 1 then
                self:backCallback(tf, var)
            end
        end
        
        
        
        tf.localPosition = Vector3(-566, 2.9, 0)
        tf.localScale = Vector3(0, 0, 1)
        
        -- 延迟1秒从下一张卡牌位置飞到原位置
        local t = TimeTicker()
        t:Start(1)
        t.OnEnd = GameResFactory.Instance():getEDC2(function(go)
            TweenPosition.Begin(self.nowMyCardtb[var].gameObject, 0.2, self.myCardConstPostb[var], true)
            TweenScale.Begin(self.nowMyCardtb[var].gameObject, 0.2, Vector3.one)
            tf.gameObject:GetComponent(typeof(UISprite)).spriteName = self.nextCardSpr.spriteName
            self.nextCardSpr.spriteName = "h" .. math.random(130)
        end)
    else -- 返回事件
        print("返回事件")
        self:backCallback(tf, var)
        -- 卡牌前置
        tf.position = self.myCardConstPostb[var]
        tf.localPosition = tf.localPosition + Vector3(0, 25, 0)
    end
end

function ui_fight:backCallback(tf, var)
    --父节点还原，临时table清空，模型销毁
    tf.parent = self.currentCards_bg
    local i = table.removebyvalue2(self.onPressMyCardtb, tf)
    if var then
        tf.localScale = Vector3.one
        Object.Destroy(table.remove(self.onPressArmytb, i).gameObject)
    else
        table.remove(self.onPressArmytb, i)
    end
end

function ui_fight:Update()
    local tempInt = #self.onPressMyCardtb
    local tempY
    for var = 1, tempInt do
        tempY = self.onPressMyCardtb[var].localPosition.y
        if tempY < -369 then --卡牌在下方区域显示并缩放，模型隐藏
            tempY = (-369 - tempY) / self.onPressMyCardSpantb[var]
            if tempY > 1 then
                self.onPressMyCardtb[var].localScale = Vector3.one
            else
                self.onPressArmytb[var].localScale = Vector3.zero
                self.onPressMyCardtb[var].localScale = Vector3(tempY, tempY, 1)
            end
        elseif tempY > 280 then --卡牌在上方区域显示并缩放，模型隐藏
            tempY = (tempY - 280) / 88
            if tempY > 1 then
                self.onPressMyCardtb[var].localScale = Vector3.one
            else
                self.onPressArmytb[var].localScale = Vector3.zero
                self.onPressMyCardtb[var].localScale = Vector3(tempY, tempY, 1)
            end
        else --卡牌在中间区域隐藏，模型显示
            self.onPressMyCardtb[var].localScale = Vector3(0, 0, 1)
            self.onPressArmytb[var].localScale = Vector3.one
        end
        
        -- 模型跟随鼠标位置移动
        local ray
        if Input.touchCount == 0 then -- 编辑器平台和手机平台不同的触摸
            ray = self.nowWorldCamera:ScreenPointToRay(Input.mousePosition)
        else
            ray = self.nowWorldCamera:ScreenPointToRay(Vector3(Input.GetTouch(var - 1).position.x, Input.GetTouch(var - 1).position.y, 0))
        end
        local isC, hit = UnityEngine.Physics.Raycast(ray, hit)
        if isC then
            self.onPressArmytb[var].position = hit.point
        end
    end
    
    --卡牌CD
    for var = 1, 4 do
        if self.nowFei < self.myCardCostFeitb[var] then
            self.nowMyCardCDtbUISpritetb[var].fillAmount = 1 - self.nowFei / self.myCardCostFeitb[var]
        else
            self.nowMyCardCDtbUISpritetb[var].fillAmount = 0
        end
    
    end
    
    --费每秒增长
    self.nowFei = self.nowFei + 1
    if self.nowFei > self.allFei then
        self.nowFei = self.allFei
        self.feiBarSpr.fillAmount = 1
    else
        self.feiBarSpr.fillAmount = self.nowFei / self.allFei
    end
    self.nowFeiLabel.text = math.round(self.nowFei) .. ""
end

function ui_fight:reset_window(args)

end

--销毁时清除该类中easytouch回调
function ui_fight:on_pre_destroy()
    GameResFactory.Instance():RemoveTouchUpHandler1()
    GameResFactory.Instance():RemoveTouchStartHandler2()
end

return ui_fight
