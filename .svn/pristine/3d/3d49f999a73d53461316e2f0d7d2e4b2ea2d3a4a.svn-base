using System;
using UnityEngine;
using System.Collections;
using System.Collections.Generic;

/// <summary>
/// 抽象类，所有状态必须继承它 并在子类中实例化
/// </summary>
public abstract class SoldierFSMState : MonoBehaviour
{
    protected SoldierStateID _stateId;

    public SoldierStateID StateID
    {
        get { return _stateId; }
        set { _stateId = value; }
    }
    private Dictionary<SoldierTriggerID, SoldierStateID> dict = new Dictionary<SoldierTriggerID, SoldierStateID>();
    private List<SoldierFSMTrigger> _fsmTrriggerList = new List<SoldierFSMTrigger>();
    public SoldierFSMState()
    {
        Init();
    }

    public abstract void Init();
    /// <summary>
    /// 添加状态 转换和状态id必须成对存在 且唯一
    /// </summary>
    /// <param name="trigger"></param>
    /// <param name="id"></param>
    public void AddTrigger(SoldierTriggerID trigger, SoldierStateID id)//增加关联对（转换，状态ID）
    {
        //-----------------------------验证参数的合法性-----------------------------------
        if (dict.ContainsKey(trigger))
        {
            Debug.LogError("FSMState ERROR: SoldierTriggerID" + id + " 已经存在" + trigger);
            return;
        }
        dict.Add(trigger, id);
        //通过转换反射出对应的触发器再把触发器添加到触发器列表
        Type type = Type.GetType(trigger + "Trigger");
        SoldierFSMTrigger fsmtrigger = Activator.CreateInstance(type) as SoldierFSMTrigger;
        _fsmTrriggerList.Add(fsmtrigger);
    }
    /// <summary>
    /// 删除某个转换 
    /// </summary>
    /// <param name="trans"></param>
    public void DeleteTransition(SoldierTriggerID trans)
    {

        if (dict.ContainsKey(trans))
        {
            dict.Remove(trans);
            return;
        }
        Debug.LogError("FSMState ERROR: " + trans + " 不存在");
    }
    /// <summary>
    ///  根据当前转换获取对应的状态
    /// </summary>
    /// <param name="trans"></param>
    /// <returns></returns>
    public SoldierStateID GetStateByTrans(SoldierTriggerID trans)
    {
        if (dict.ContainsKey(trans))
        {
            return dict[trans];
        }
        return SoldierStateID.NullState;
    }
    /// <summary>
    /// 子类中覆写，进入状态前的准备工作
    /// </summary>
    public virtual void DoBeforeEntering() { }
    /// <summary>
    /// 子类中覆写，离开状态之前的处理工作 清理当前状态的过期数据等
    /// </summary>
    public virtual void DoBeforeLeaving() { }

    /// <summary>
    /// 状态的改变发生在这里
    /// </summary>
    public void Reason(SoldierFSMSystem fsm)
    {
        for (int i = 0; i < _fsmTrriggerList.Count; i++)
        {
            if (_fsmTrriggerList[i].CheckTrigger(fsm))
            {
                fsm.ChangeState(dict[_fsmTrriggerList[i].triggerId]);
                break;
            }
        }
    }
    /// <summary>
    /// 删除对应id的触发器
    /// </summary>
    /// <param name="triggerId"></param>
    public void RemoveTrigger(SoldierTriggerID triggerId)
    {
        if (dict.ContainsKey(triggerId))
        {
            dict.Remove(triggerId);
            _fsmTrriggerList.Remove(_fsmTrriggerList.Find((e) => triggerId == e.triggerId));
        }
    }
    public abstract void Act(SoldierFSMSystem fsm);
}









/// <summary>
/// 士兵的各个状态
/// </summary>
public enum SoldierStateID
{
    //入场
    RuChang,
    //待机
    DaiJi,
    //行进
    Xingjin,
    //死亡
    SiWang,
    //尸体
    ShiTi,
    //隐身
    YinShen,
    //普通攻击中状态
    PutongGongji,
    //技能攻击中状态
    JinengGongji,
    //受击状态
    Shouji,
    //混乱状态
    Hunluan,
    NullState = -10001
}

/// <summary>
/// 定义Transition(转换)类型的枚举变量，以后根据需要扩展
/// </summary>
public enum SoldierTriggerID
{
    //入场
    RuChangTri,
    //待机
    DaiJiTri,
    //行进
    XingjinTri,
    //死亡
    SiWangTri,
    //尸体
    ShiTiTri,
    //隐身
    YinShenTri,
    //普通攻击
    PutongGongjiTri,
    //技能攻击
    JinengGongjiTri,
    //受击
    ShoujiTri,
    //混乱
    HunluanTri,
    NullTri = -10001
}
