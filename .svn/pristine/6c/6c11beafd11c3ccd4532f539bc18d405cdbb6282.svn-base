using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using UniLua;
using UnityEngine;
using MonoEX;
using CHttp;

public class LuaGameConnLib
{
    public class LuaHttpRequestEventCallBack : LuaEventCallback
    {
        protected override void _Call(object param)
        {
            LuaCHttpRequestLib._wrap(LuaRoot._Lua, param as CHttpRequest);
            using (LuaValue_Any request = new LuaValue_Any(LuaRoot._Lua.L_Ref(LuaDef.LUA_REGISTRYINDEX)))
            {
                base._Call(request);
            }
        }
    }

    static LuaClassRegHelper m_ClassRegHelper = new LuaClassRegHelper();

    public const string LIB_NAME = "YQ2GameConn";

    public static int OpenLib(ILuaState lua)
    {
        //注册成员函数
        NameFuncPair[] member_define = new NameFuncPair[]
        {

        };
         
        NameFuncPair[] operator_define = new NameFuncPair[]
        {
           
        };

        m_ClassRegHelper.RegMembers(lua, member_define, operator_define);


        //注册静态成员
        NameFuncPair[] static_define = new NameFuncPair[]
        {
            new NameFuncPair("CreateLoader",S_CreateLoader),
            new NameFuncPair("SendRequest",S_SendRequest),
            
        };

        //注册静态属性
        NameValuePair[] static_property = new NameValuePair[]
        {
            new NameValuePair("Name",LIB_NAME),
        };

        m_ClassRegHelper.RegStatics(lua, static_define,static_property);

        return 1;
    }

    static int S_CreateLoader(ILuaState lua)
    {
        var msg = LuaQKJsonLib.Lua2Obj(lua, 2) as QK_JsonValue_Map;
        lua.L_ArgCheck(msg != null,2,"消息不是jsonmap");

        int flag = (byte)lua.L_CheckInteger(3);

        LuaHttpLoaderLib._wrap(lua,YQ2GameConn.Single.CreateLoader(msg, flag));

        return 1;
    }

    static int S_SendRequest(ILuaState lua)
    {
        var msg = LuaQKJsonLib.Lua2Obj(lua, 2) as QK_JsonValue_Map;
        lua.L_ArgCheck(msg != null, 2, "消息不是jsonmap");

        int flag = (byte)lua.L_CheckInteger(3);

        bool delaySupport = lua.ToBoolean(4);

        LuaHttpRequestEventCallBack cbk = LuaRoot.LDelegate2EventCallback<LuaHttpRequestEventCallBack>(lua, 5, 6);

        YQ2GameConn.Single.SendRequest(msg, flag, cbk, delaySupport);

        return 1;
    }
}
