using UnityEngine;
using System.Collections;
using System.Collections.Generic;
/// <summary>
/// 状态机主类 管理各状态切换
/// </summary>
public class SoldierFSMSystem {
    private List<SoldierFSMState> _states;
    /// <summary>
    /// 允许状态机持有显示对象
    /// </summary>
    public GameObject Display;

    /// <summary>
    /// 是否可以开始走的标记 只被用在判断士兵入场以后是否已经经过了一秒的等待
    /// </summary>
    public bool IsCanRun = false;

    private SoldierStateID _currentStateId;
    //不要直接修改这个变量，之所以让他公有是因为得让其他脚本调用这个变量。
    public SoldierStateID CurrentStateID { get { return _currentStateId; } }
    //记录当前状态
    private SoldierFSMState _currentState;
    public SoldierFSMState CurrentState { get { return _currentState; } }

    public SoldierFSMSystem()
    {
        _states = new List<SoldierFSMState>();
    }
    /// <summary>
    /// 增加状态转换对 第一次添加的状态是默认状态
    /// </summary>
    /// <param name="s"></param>
    public void AddState(SoldierFSMState s)
    {
        //_currentState = _states.Find((e) => e.StateID == s.StateID);
        if (s == null)
        {
            Debug.LogError("SoldierFSM ERROR: Null reference is not allowed");
        }

        if (_states.Count == 0)
        {
            _states.Add(s);
            ChangeState(s.StateID);
            return;
        }
        //排除相同的状态
        foreach (SoldierFSMState state in _states)
        {
            if (state.StateID == s.StateID)
            {
                Debug.LogError("SoldierFSM ERROR: Impossible to add state " + s.StateID.ToString() +
                               " because state has already been added");
                return;
            }
        }
        _states.Add(s);
    }

    /// <summary>
    /// 跟据ID来从容器states中定向移除FSMState实例
    /// </summary>
    /// <param name="id"></param>
    public void DeleteState(SoldierStateID id)
    {

        if (id == SoldierStateID.NullState)

        {
            Debug.LogError("FSM ERROR: NullStateID is not allowed for a real state");
            return;
        }


        foreach (SoldierFSMState state in _states)

        {
            if (state.StateID == id)
            {
                _states.Remove(state);
                return;
            }
        }
        Debug.LogError("FSM ERROR: Impossible to delete state " + id.ToString() +
                       ". It was not on the list of _states");
    }
    /// <summary>
    /// 查找并切换对应id的状态 
    /// </summary>
    /// <param name="stateId"></param>
    public void ChangeState(SoldierStateID stateId)
    {
        if (stateId == SoldierStateID.NullState)

        {
            Debug.LogError("SoldierFSM ERROR: 不允许切换空状态");

        }

        foreach (SoldierFSMState state in _states)//遍历此状态容器 
        {
            if (state.StateID == stateId)
            {
                if (null != _currentState)
                {
                    _currentState.DoBeforeLeaving(this);
                }
                //只允许在这里切换状态
                _currentState = state;
                _currentStateId = state.StateID;
                Debug.Log("执行状态切换-------------------" + state.StateID);
                if (null != _currentState)
                {
                    _currentState.DoBeforeEntering(this);
                }
                break;
            }
        }
    }
}
