using System;
using System.Collections.Generic;
using System.Linq;
using System.Text; 
using System.Xml;


public enum Sex
{
    None = 0,
    Man = 1,
    Woman = 2,
    All = 3
}


public class HeroRestraintOnce
{
    public HeroType heroType;
    public float Modulus;
    public float DefModulus;
};

    public class XingAttr
    {
        public float HP;
        public float Wuli;
        public float Tili;
        public float Nu;
    }

    public class HeroDataInfo:IHeroInfo
    {
        internal static short IID;
        internal static short IName;
        internal static short IHanhua;
        internal static short ISex;
        internal static short IMingziID;
        internal static short ISpecial;
        internal static short IHistory;
        internal static short IYouxianZhenwei;
        internal static short IType; 
        internal static short IMorenXing;
        internal static short IArmy;
        internal static short IHeroZhenying;
        internal static short IIsZhaomu;
        internal static short ITypeIcon; 
        internal static short[] ISkills;
        internal static short IAtkRange;
        internal static short ISpeed;
        internal static short IHeroFace;
        internal static short IHeroBanshen;
        internal static short ISurrenderCostID;
        internal static short[] ISkillAtks;
        internal static short IZiyuanBaoming;
        internal static short IArmyTaopao;
        internal static short IZiyuanBaomingZuoqi;
        internal static short IHeroZhaomuType;
        internal static short IIsQixi;
        internal static short IStartNengliang; 
        internal static short IBiliHP;
        internal static short IBiliWuli;
        internal static short IBiliTili;
        internal static short IBiliNu;
        internal static short IBiliJingshen;
        internal static short IBiliZhili;

        internal static short IYinchangAudioFx;
        internal static short ITongYongSuiPian;
        internal static short IHtitleHeroTitle;

        internal static short IWushuang;

        internal static short IHeroDeadAudioFx;
        internal static short IIsWeizhi;

        internal static short IMoxingRange;

        internal static void FillFieldIndex(ITabReader reader)
        {
            IID = reader.ColumnName2Index("ID");
            IName = reader.ColumnName2Index("Name");
            IHanhua = reader.ColumnName2Index("Hanhua");
            ISex = reader.ColumnName2Index("Sex");
            IMingziID = reader.ColumnName2Index("MingziID");
            ISpecial = reader.ColumnName2Index("Special");
            IHistory = reader.ColumnName2Index("History");
            IYouxianZhenwei = reader.ColumnName2Index("YouxianZhenwei");
            IType = reader.ColumnName2Index("Type");
            IMorenXing = reader.ColumnName2Index("MorenXing");
            IArmy = reader.ColumnName2Index("Army");
            IHeroZhenying = reader.ColumnName2Index("HeroZhenying");
            IIsZhaomu = reader.ColumnName2Index("IsZhaomu");
            IWushuang = reader.ColumnName2Index("Wushuang");
            ITypeIcon = reader.ColumnName2Index("TypeIcon"); 
            IAtkRange = reader.ColumnName2Index("AtkRange");
            ISpeed = reader.ColumnName2Index("Speed");
            IHeroFace = reader.ColumnName2Index("HeroFace");
            IHeroBanshen = reader.ColumnName2Index("HeroBanshen");
            IZiyuanBaoming = reader.ColumnName2Index("ZiyuanBaoming");
            IArmyTaopao = reader.ColumnName2Index("ArmyTaopao");
            ISurrenderCostID = reader.ColumnName2Index("SurrenderCostID");
            IZiyuanBaomingZuoqi = reader.ColumnName2Index("ZiyuanBaomingZuoqi");
            ISkillAtks = new short[SData_HeroData.MaxSkillCount];
            ISkills = new short[SData_HeroData.MaxSkillCount];
            for (int i = 0; i < SData_HeroData.MaxSkillCount; i++)
            {
                var istr = (i + 1).ToString();
                ISkillAtks[i] = reader.ColumnName2Index("Skill"+istr+"Atk"   );
                ISkills[i] = reader.ColumnName2Index("Skill" + istr);
            }
            IStartNengliang = reader.ColumnName2Index("StartNengliang");
            IMoxingRange = reader.ColumnName2Index("MoxingRange");

            IHeroDeadAudioFx = reader.ColumnName2Index("HeroDeadAudioFx");

            IBiliHP = reader.ColumnName2Index("BiliHP");
            IBiliWuli = reader.ColumnName2Index("BiliWuli");
            IBiliTili = reader.ColumnName2Index("BiliTili");
            IBiliNu = reader.ColumnName2Index("BiliNu");

            IBiliJingshen = reader.ColumnName2Index("BiliJingshen");
            IBiliZhili = reader.ColumnName2Index("BiliZhili");


            IYinchangAudioFx = reader.ColumnName2Index("YinchangAudioFx");
            IHeroZhaomuType = reader.ColumnName2Index("HeroZhaomuType");
            ITongYongSuiPian = reader.ColumnName2Index("TongyongSuipian");
            IHtitleHeroTitle = reader.ColumnName2Index("HtitleHeroTitle");
            IIsQixi = reader.ColumnName2Index("IsQixi");

            IIsWeizhi = reader.ColumnName2Index("IsWeizhi");
        }

        internal HeroDataInfo(ITabReader reader, int row)
        {
            _ID = reader.GetI32(IID, row);
            _Sex = (Sex)reader.GetI16(ISex, row);
            _MingziID = reader.GetI16(IMingziID, row);
            _Type = (HeroType)reader.GetI16(IType, row);
            _MorenXing = reader.GetI16(IMorenXing, row);

            _HeroZhenying = (HeroZhenyingEnum)reader.GetI16(IHeroZhenying, row);
            IsZhaomu =( reader.GetI16(IIsZhaomu, row)==1);
            IsWushuang = (reader.GetI16(IWushuang, row) == 1);
            _TypeIcon = reader.GetI16(ITypeIcon, row);
            _AtkRange = reader.GetI16(IAtkRange, row);
            _Speed = reader.GetI16(ISpeed, row);
            _HeroBanshen = reader.GetS(IHeroBanshen, row);
            SurrenderCostID = reader.GetI16(ISurrenderCostID, row);
            _ZiyuanBaomingZuoqi = reader.GetS(IZiyuanBaomingZuoqi, row);
            _HeroDeadAudioFx = reader.GetI32(IHeroDeadAudioFx, row);
            YinchangAudioFx = reader.GetI32(IYinchangAudioFx, row);

            _MoxingRange = reader.GetI16(IMoxingRange, row);

            _SkillAtks = new string[SData_HeroData.MaxSkillCount];
            _Skills = new int[SData_HeroData.MaxSkillCount];
            for (int i = 0; i < SData_HeroData.MaxSkillCount; i++)
            {
                _SkillAtks[i] = reader.GetS(ISkillAtks[i], row);
                _Skills[i] = reader.GetI32(ISkills[i], row);
            }
            _ArmyTaopao = (float)reader.GetI16(IArmyTaopao, row) / 100f;
            _Army = reader.GetI32(IArmy, row);

            _Name = reader.GetS(IName, row);
            _Hanhua = reader.GetS(IHanhua, row);
            _Special = reader.GetS(ISpecial, row);
            History = reader.GetS(IHistory, row);
            _HeroFace = reader.GetS(IHeroFace, row);
            _ZiyuanBaoming = reader.GetS(IZiyuanBaoming, row);
            _HeroFaceID = int.Parse(_HeroFace.Substring(1, _HeroFace.Length - 1));

            _BiliHP = reader.GetF(IBiliHP, row);
            _BiliWuli = reader.GetF(IBiliWuli, row);
            _BiliTili = reader.GetF(IBiliTili, row);
            _BiliNu = reader.GetF(IBiliNu, row); 
            BiliJingshen = reader.GetF(IBiliJingshen, row);
            BiliZhili = reader.GetF(IBiliZhili, row);

            _StartNengliang = reader.GetI16(IStartNengliang, row);
            IsQixi = reader.GetI16(IIsQixi, row) == 1;

            HeroZhaomuType = reader.GetI16(IHeroZhaomuType, row);
            TongYongSuiPian = reader.GetI16(ITongYongSuiPian, row);
            HtitleHeroTitle = reader.GetS(IHtitleHeroTitle, row);
            IsWeizhi = reader.GetI16(IIsWeizhi, row);
            

        }
        public readonly int _HeroFaceID;
        public readonly int _ID;
        public readonly string _ZiyuanBaoming;
        public readonly Sex _Sex;
        public readonly short SurrenderCostID;
        public readonly short _MingziID;
        public readonly HeroType _Type;
        public readonly short _MorenXing;
        public readonly HeroZhenyingEnum _HeroZhenying;
        public readonly bool IsZhaomu;
        public readonly bool IsWushuang;
        public readonly short _TypeIcon;
        public readonly short HeroZhaomuType; 
        public readonly short _AtkRange;
        public readonly short _Speed;
        public readonly string _HeroBanshen;
        public readonly string HtitleHeroTitle;
        public readonly string[] _SkillAtks;
        public readonly int[] _Skills;
        public readonly int _Army;
        public readonly int TongYongSuiPian;
        public readonly int IsWeizhi;
        public readonly short _MoxingRange;

        public short ModelRange
        {
            get
            {
                if (_MoxingRange == 2||_MoxingRange ==3) return 1;
                return (short)((_MoxingRange - 1) / 6);
            }
        }


        public readonly short _StartNengliang;
        public short StartNengliang { get { return _StartNengliang; } }
        public short TypeIcon { get { return _TypeIcon; } }

        ArmyInfo ArmyObj;

        public readonly float _BiliHP ;
        public readonly float _BiliWuli  ;
        public readonly float _BiliTili ;
        public readonly float _BiliNu ;


        public float BiliHP { get { return _BiliHP; } }
        public float BiliWuli { get { return _BiliWuli; } }
        public float BiliTili { get { return _BiliTili; } }
        public float BiliNu { get { return _BiliNu; } }


        public readonly float BiliJingshen;
        public readonly float BiliZhili;
        public readonly bool IsQixi;


        //public readonly float _xingNu;
        //public readonly float _xingTili;
        //public readonly float _xingWuli;
        //public readonly float _xingHP;
        public readonly string _Name;
        public readonly string _Hanhua;
        public readonly string _Special;
        public readonly string History;
        public readonly string _HeroFace;
        public readonly string _ZiyuanBaomingZuoqi;

        public readonly float _ArmyTaopao;
        public float ArmyTaopao { get { return _ArmyTaopao; } }

        public HeroType Type { get { return _Type; } }
        public short MorenXing { get { return _MorenXing; } }
        public int HeroFaceID { get { return _HeroFaceID; } }
        public HeroZhenyingEnum HeroZhenying { get { return _HeroZhenying; } }
     
        public short AtkRange { get { return _AtkRange; } }
        public short Speed { get { return _Speed; } }




        public readonly int _HeroDeadAudioFx;
        public AudioFxInfo HeroDeadAudioFxObj { get { return _HeroDeadAudioFxObj; } }

        AudioFxInfo _HeroDeadAudioFxObj = null;


        public string ZiyuanBaomingZuoqi { get { return _ZiyuanBaomingZuoqi; } }

        public string HeroBanshen { get { return _HeroBanshen; } }
        public string[] SkillAtks { get { return _SkillAtks; } }

        public string ZiyuanBaoming { get { return _ZiyuanBaoming; } }

        public int[] Skills { get { return _Skills; } }

        public int CalculationHP( int level, short xj)
        {
            var jichu = SData_FightKeyValueMath.Single.Get(level).HeroGudingHP[xj - 1] +
       SData_FightKeyValueMath.Single.Get(level).HeroGrowHP;
            return (int)(jichu * BiliHP);
        }

        public int CalculationWuli( int level, short xj)
        {
            var jichu = SData_FightKeyValueMath.Single.Get(level).HeroGudingWuli[xj - 1] +
       SData_FightKeyValueMath.Single.Get(level).HeroGrowWuli;
            return (int)(jichu * BiliWuli);
        }

        public int CalculationTili( int level, short xj)
        {
            var jichu = SData_FightKeyValueMath.Single.Get(level).HeroGudingTili[xj - 1] +
       SData_FightKeyValueMath.Single.Get(level).HeroGrowTili;
            return (int)(jichu * BiliTili);
        }

        public int CalculationNu(int level, short xj)
        {
            var jichu = SData_FightKeyValueMath.Single.Get(level).HeroGudingNu[xj - 1] +
      SData_FightKeyValueMath.Single.Get(level).HeroGrowNu;
            return (int)(jichu * BiliNu);
        }


        public int CalculationZhili(int level, short xj)
        {
            var jichu = SData_FightKeyValueMath.Single.Get(level).HeroGudingZhili[xj - 1] +
            SData_FightKeyValueMath.Single.Get(level).HeroGrowZhili;
            return (int)(jichu * BiliZhili);
        }

        public int CalculationJingshen(int level, short xj)
        {
            var jichu = SData_FightKeyValueMath.Single.Get(level).HeroGudingJingshen[xj - 1] +
            SData_FightKeyValueMath.Single.Get(level).HeroGrowJingshen;
            return (int)(jichu * BiliJingshen);
        }
        public void BuildLinks()
        { 

            int len = _Skills.Length;
            _SkillObjs = new Skill[len];
            for (int i = 0; i < len; i++)
            {
                var skid = _Skills[i];
                _SkillObjs[i] = skid <= 0 ? null : SData_Skill.Single.Get(skid);
            }

            ArmyObj = SData_Army.Single.Get(_Army);
            if (ArmyObj == null) throw new Exception("英雄表引用了不存在的士兵ID:" + _Army.ToString());

            if (YinchangAudioFx > 0) _YinchangAudioFxObj = SData_AudioFx.Single.Get(YinchangAudioFx);
            if (_HeroDeadAudioFx > 0) _HeroDeadAudioFxObj = SData_AudioFx.Single.Get(_HeroDeadAudioFx);

        }

        public Skill[] SkillObjs { get { return _SkillObjs; } }
        Skill[] _SkillObjs;
        /// <summary>
        /// 获取技能索引号
        /// </summary>
        public short GetSkillIndex(int skillID)
        {
            short len = (short)_Skills.Length;
            for (short i = 0; i < len; i++) if (_Skills[i] == skillID) return i;

            return -1;
        }

        public int ID { get { return _ID; } }
        public Sex Sex { get { return _Sex; } }
        public short MingziID { get { return _MingziID; } }
        public string Name { get { return _Name; } }
        public string Hanhua { get { return _Hanhua; } }
        public string Special { get { return _Special; } }
        public string HeroFace { get { return _HeroFace; } }

        public ArmyInfo Army { get { return ArmyObj; } }

        public AudioFxInfo YinchangAudioFxObj { get { return _YinchangAudioFxObj; } }

        int YinchangAudioFx;
        public AudioFxInfo _YinchangAudioFxObj;
    }

    public class SData_HeroData : MonoEX.Singleton<SData_HeroData>
    {
        public const int MaxSkillCount = 6;

        public SData_HeroData()
        {
            MonoEX.Debug.Logout(MonoEX.LOG_TYPE.LT_INFO, "开始装载 HeroData");
            using (ITabReader reader = TabReaderManage.Single.CreateInstance())
            {
                reader.Load("bsv", "HeroData");

                HeroDataInfo.FillFieldIndex(reader);
                
                int rowCount = reader.GetRowCount();
                for (int row = 0; row < rowCount; row++)
                {
                    HeroDataInfo sa = new HeroDataInfo(reader, row);
                    if (Data.ContainsKey(sa.ID))
                        MonoEX.Debug.Logout(MonoEX.LOG_TYPE.LT_ERROR, "重复的ID：" + sa.ID.ToString());
                    Data.Add(sa.ID, sa); 
                }
            }
          
        }


        public void BuildLinks()
        {
            MonoEX.Debug.Logout(MonoEX.LOG_TYPE.LT_INFO, "HeroData 开始建立对象关联");

            foreach (var kv in Data) kv.Value.BuildLinks();
        }


        public List<int> GetALLRecruitHero()
        {
            List<int> _temp = new List<int>();
            foreach (KeyValuePair<int, HeroDataInfo> kv in Data)
            {
                if(kv.Value.IsZhaomu)
                    _temp.Add(kv.Key);
            }
            return _temp;
        }

        public List<int> GetALLHero()
        {
            List<int> _temp = new List<int>();
            foreach (KeyValuePair<int, HeroDataInfo> kv in Data)
            {
                    _temp.Add(kv.Key);
            }
            return _temp;
        }

        public HeroDataInfo GetHeroData(int heroId)
        {
            try
            {
                if (!Data.ContainsKey(heroId)) return null;
                return Data[heroId];
            }
            catch (Exception)
            {
                throw new Exception(String.Format("SData_Hero::Get() not found data  heroId:{0}", heroId)); 
            }
        } 
              
        internal Dictionary<int, HeroDataInfo> Data = new Dictionary<int, HeroDataInfo>();  
    }

    //1星固定 * 4星固定加成 + (等级-1)*1星成长*4星加成
    


    public class SData_Hero
    {
        public static IHeroInfo Get(int id)
        {
           IHeroInfo re = SData_HeroData.Single.GetHeroData(id);
           if (re != null) return re;
           return SData_MonsterData.Single.Get(id);
        }


    }
