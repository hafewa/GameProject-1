local class = require("common/middleclass")
local ui_equip = class("ui_equip", wnd_base)


--左侧装备栏显示操作 0-99为删除 100-199为添加 200-299为修改
local function ZUOCEZHUANGBEI(type, i, v)
    local self = ui_equip
    if type ~= 1 then --type==1 为初始化操作
        self:setSuitData()
    end
    
    if type < 100 then --删除
        self.eqBg[i]:GetComponent(typeof(UISprite)).spriteName = "pz_0" .. 7
        self.eqBg[i]:Find("level").gameObject:SetActive(false)
        --如果有可穿戴装备则显示加号
        if equipP.allEqList[i] ~= 0 then
            local noBadNum = 0 --没有损坏的装备数目
            for j, v in ipairs(equipP.allEqList[i]) do
                if v.IsBad == 0 then
                    noBadNum = noBadNum + 1
                    break
                end
            end
            if noBadNum == 0 then
                self.eqBg[i]:Find("eqSpr").gameObject:SetActive(false)
            else
                self.eqBg[i]:Find("eqSpr").gameObject:SetActive(true)
                self.eqBg[i]:Find("eqSpr"):GetComponent(typeof(UISprite)).color = Color(1, 1, 1, 1)
                self.eqBg[i]:Find("eqSpr"):GetComponent(typeof(UISprite)).spriteName = "h96"
            end
        else
            self.eqBg[i]:Find("eqSpr").gameObject:SetActive(false)
        end
    elseif type < 200 then --添加
        self.eqBg[i]:Find("eqSpr").gameObject:SetActive(true)
        self.eqBg[i]:Find("level").gameObject:SetActive(true)
        self.xiexia.gameObject:SetActive(true)
        setEqIconView(self.eqBg[i], v)
    else --修改
        setEqIconView(self.eqBg[i], v)
    end
end

--右侧装备列表显示操作 0-99为删除 100-199为添加 200-299为修改
local function YOUCEZHUANGBEI(type, i, v, i2)
    local self = ui_equip
    -- self:setSuitData()
    if type < 100 then --删除
        sortEqList(i)
        Object.Destroy(table.remove(self.ceqTB, v).gameObject)
        --如果卸下按钮隐藏startX = 1
        local startX = self.xiexia.gameObject.activeSelf and 0 or 1
        for j = 1, #self.ceqTB do
            self.ceqTB[j].localPosition = Vector3((j - startX) % self.eqUIGridMPL * self.eqUIGridCW, -math.modf((j - startX) / self.eqUIGridMPL) * self.eqUIGridCH, 0)
        end
    elseif type < 200 then --添加/卸下左侧后添加
        local go = GameObjectExtension.InstantiateFromPacket("ui_equip", "eqBg", self.eqGrid.gameObject)
        setEqIconView(go.transform, v)
        --装备添加触摸
        UIEventListener.Get(go).onClick = function(go)
            eqChangeIndex = table.indexof(equipP.allEqList[i], v)
            if equipP.nowEqList[i] == 0 then --如果对应的装备栏为空
                self.simple_state_machine:do_event("change11", v)
            else
                self.simple_state_machine:do_event("change6", i, v)
            end
        end
        
        sortEqList(i)
        local index2 = table.indexof(equipP.allEqList[i], v)
        table.insert(self.ceqTB, index2, go.transform)
        --如果卸下按钮隐藏startX = 1
        local startX = self.xiexia.gameObject.activeSelf and 0 or 1
        local tempJ = 1
        if type == 100 then --添加（加入元素的后边元素向后移动），卸下为加入元素的前边元素向前移动
            tempJ = index2
            index2 = #self.ceqTB
        end
        for j = tempJ, index2 do
            self.ceqTB[j].localPosition = Vector3((j - startX) % self.eqUIGridMPL * self.eqUIGridCW, -math.modf((j - startX) / self.eqUIGridMPL) * self.eqUIGridCH, 0)
        end
    else --修改
        setEqIconView(self.ceqTB[i2], v)
        sortEqList(i)
        local index2 = table.indexof(equipP.allEqList[i], v)
        if index2 ~= i2 then -- 如果修改了装备后排序有变化
            table.insert(self.ceqTB, index2, table.remove(self.ceqTB, i2))
            --如果卸下按钮隐藏startX = 1
            local startX = self.xiexia.gameObject.activeSelf and 0 or 1
            local tempJ = math.min(i2, index2)
            local len = #self.ceqTB
            for j = tempJ, len do
                self.ceqTB[j].localPosition = Vector3((j - startX) % self.eqUIGridMPL * self.eqUIGridCW, -math.modf((j - startX) / self.eqUIGridMPL) * self.eqUIGridCH, 0)
            end
        end
    end
end


--交换左右侧装备
local function EXCHANGEZHUANGBEI(i, i2, v1, v2)
    local self = ui_equip
    self:setSuitData()
    setEqIconView(self.eqBg[i], v2)
    sortEqList(i)
    local index = table.indexof(equipP.allEqList[i], v1)
    
    table.insert(self.ceqTB, index, table.remove(self.ceqTB, i2))
    --装备添加触摸
    UIEventListener.Get(self.ceqTB[index].gameObject).onClick = function(go)
        if equipP.nowEqList[i] == 0 then --如果对应的装备栏为空
            self.simple_state_machine:do_event("change11", v1)
        else
            self.simple_state_machine:do_event("change6", i, v1)
        end
    end
    setEqIconView(self.ceqTB[index], v1)
    local startX = 0
    for j = 1, #self.ceqTB do
        self.ceqTB[j].localPosition = Vector3((j - startX) % self.eqUIGridMPL * self.eqUIGridCW, -math.modf((j - startX) / self.eqUIGridMPL) * self.eqUIGridCH, 0)
    end
end
local badColor = Color(197 / 255, 56 / 255, 56 / 255, 255 / 255)
local mainColor = Color(255 / 255, 195 / 255, 0)
local fuJiaColor = Color(73 / 255, 142 / 255, 255 / 255)
local suitColor = Color(9 / 255, 255 / 255, 0)
function ui_equip:OnShowDone()
    ui_equip = self
    
    --添加RenderTexture 实现UI上添加3d模型
    local playerModelTexture = self.transform:Find("bg1/playerModelTexture")
    local Camera3D = self.transform:Find("Camera3D")
    self.myTexture = UnityEngine.RenderTexture(1024, 1024, 24)
    self.myTexture:Create()
    Camera3D:GetComponent(typeof(UnityEngine.Camera)).targetTexture = self.myTexture
    playerModelTexture:GetComponent(typeof(UITexture)).mainTexture = self.myTexture
    --添加玩家3d模型
    tempMod = DP_FightPrefabManage.InstantiateAvatar(CreateActorParam(AvatarCM.Infantry_R, false, 0, "daobing", "daobing", true)).transform
    tempMod.parent = Camera3D
    tempMod.localScale = Vector3(1, 1, 1);
    tempMod.localRotation = Quaternion(0, 180, 0, 1);
    tempMod.localPosition = Vector3(0, -7, 500);
    tempMod.gameObject:SetActive(true)
    tempMod.gameObject.layer = UnityEngine.LayerMask.NameToLayer("3DUI")
    
    playerModelTexture:GetComponent(typeof(SpinWithMouse)).target = tempMod
    
    --未穿戴的装备排序（TODODO：放到获取数据的地方）
    for i = 1, #equipP.allEqList do
        if equipP.allEqList[i] ~= nil then
            sortEqList(i)
        end
    end
    self:setSuitData()
    
    self.bg3 = self.transform:Find("bg3")--装备详情单独界面
    self.bg4 = self.transform:Find("bg4")--未装备详情单独界面
    self.bg5 = self.transform:Find("bg5")--人物属性详情单独界面
    self.bg5SV = self.bg5:Find("Scroll View")--人物属性详情单独界面UIScrollView
    self.back1 = self.transform:Find("bg1/back1")--返回主界面按钮
    self.back2 = self.transform:Find("bg1/back2")--返回仓库按钮
    self.info = self.transform:Find("bg1/info")--详细属性按钮
    self.shizhuang = self.transform:Find("bg1/shizhuang")--时装按钮
    self.yjzb = self.transform:Find("bg1/yjzb")--一键装备按钮
    self.eqUse = self.transform:Find("bg2/eqUse")--更换装备界面
    self.eqGrid = self.eqUse:Find("Scroll View/eqGrid")--eq UIGrid
    self.roleShuXing = self.transform:Find("bg2/roleShuXing")--人物属性详情界面
    self.eqShuXingBg = self.transform:Find("bg2/eqShuXingBg")--装备详情界面
    self.fenxiang = self.eqShuXingBg:Find("fenxiang")--分享按钮
    self.genghuan = self.eqShuXingBg:Find("genghuan")--更换装备按钮
    self.bg4genghuan = self.bg4:Find("genghuan")--弹出的二级框上的更换或穿戴装备按钮
    self.suoding = self.eqShuXingBg:Find("suoding")--锁定装备按钮
    self.qianghua = self.eqShuXingBg:Find("qianghua")--强化/重铸/修理按钮
    self.bg4Qianghua = self.bg4:Find("qianghua")--未装备详情单独界面强化/重铸/修理按钮
    self.qianghuaJiaGeUL = self.qianghua:Find("jiage"):GetComponent(typeof(UILabel))--强化/重铸/修理价格
    self.bg4QianghuaJiaGeUL = self.bg4Qianghua:Find("jiage"):GetComponent(typeof(UILabel))--未装备详情单独界面强化/重铸/修理价格
    self.eqShuXingXieXia = self.eqShuXingBg:Find("xiexia")--装备详情页卸下按钮
    self.xiexia = self.eqGrid:Find("xiexia")--卸下按钮
    self.nowEqBg = self.eqShuXingBg:Find("eqShuXing/eqBg")--装备详情页装备图标Bg
    self.nowEqBgEqSpr = self.nowEqBg:Find("eqSpr")
    self.nowEqBgLevel = self.nowEqBg:Find("level")
    self.battleWidget = self.transform.parent:Find("ui_equip_baffle"):GetComponent(typeof(UIWidget))
    eqChangeType = 0 --更换整备界面为哪种类型装备
    eqChangeIndex = 0 --更换整备界面为哪件装备Index
    eqInfoType = 0 --装备详情界面为哪种类型装备
    self.eqBg = {}--装备栏按钮Table
    self.ceqTB = {}--右侧装备Table
    
    
    
    --获取3个界面的装备属性各个组件
    self.bgShuXing = {{}, {}, {}}
    local nameT1 = {"bg2/eqShuXingBg/", "bg3/", "bg4/"}
    local eqShuXing
    for i = 1, 3 do
        eqShuXing = self.transform:Find(nameT1[i] .. "eqShuXing")
        self.bgShuXing[i].EqSprSprite = eqShuXing:Find("eqBg/eqSpr"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].EqBgSprSprite = eqShuXing:Find("eqBg"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].EQLevelLabel = eqShuXing:Find("eqBg/level"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].eqName = eqShuXing:Find("eqBg/eqName"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingMain = eqShuXing:Find("shuxingMain"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingFuJia1 = eqShuXing:Find("shuxingFuJia1"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingFuJia2 = eqShuXing:Find("shuxingFuJia2"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingFuJia3 = eqShuXing:Find("shuxingFuJia3"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingFuJia4 = eqShuXing:Find("shuxingFuJia4"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingFuJia5 = eqShuXing:Find("shuxingFuJia5"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingFuJia1SuoSpr = eqShuXing:Find("shuxingFuJia1/suoSpr"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].shuxingFuJia2SuoSpr = eqShuXing:Find("shuxingFuJia2/suoSpr"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].shuxingFuJia3SuoSpr = eqShuXing:Find("shuxingFuJia3/suoSpr"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].shuxingFuJia4SuoSpr = eqShuXing:Find("shuxingFuJia4/suoSpr"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].shuxingFuJia5SuoSpr = eqShuXing:Find("shuxingFuJia5/suoSpr"):GetComponent(typeof(UISprite))
        self.bgShuXing[i].shuxingSuit1 = eqShuXing:Find("shuxingSuit1"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingSuit2 = eqShuXing:Find("shuxingSuit2"):GetComponent(typeof(UILabel))
        self.bgShuXing[i].shuxingSuit3 = eqShuXing:Find("shuxingSuit3"):GetComponent(typeof(UILabel))
    end
    
    
    local eqUIGrid = self.eqGrid:GetComponent(typeof(UIGrid))
    self.eqUIGridCW = eqUIGrid.cellWidth
    self.eqUIGridCH = eqUIGrid.cellHeight
    self.eqUIGridMPL = eqUIGrid.maxPerLine
    --state1  右侧为装备详情界面
    --state2  右侧为更换装备界面
    --state3  右侧为人物属性详情界面
    --state4  左侧为单独装备详情界面，右侧为更换装备界面
    --state6  左左侧为单独装备详情界面，左右侧为待更换的装备详情界面，右侧为更换装备界面
    --state7  左侧为单独装备详情界面，右侧为人物属性详情界面
    --state11 左右侧为待更换的装备详情界面，右侧为更换装备界面
    -- --state12 无任何界面弹出，
    -- --state13 无任何界面弹出，
    --状态机
    simple_state_machine = require("common/simple_state_machine")
    self.simple_state_machine = simple_state_machine()
    self.simple_state_machine:setup_state({
        initial = "state1",
        events = {
            {name = "change1", from = "state1", to = "state1"},
            {name = "change1", from = "state2", to = "state1"},
            {name = "change1", from = "state3", to = "state1"},
            {name = "change1", from = "state4", to = "state1"},
            {name = "change1", from = "state11", to = "state1"},
            {name = "change2", from = "state1", to = "state2"},
            {name = "change2", from = "state2", to = "state2"},
            {name = "change2", from = "state3", to = "state2"},
            {name = "change2", from = "state4", to = "state2"},
            {name = "change2", from = "state6", to = "state2"},
            {name = "change2", from = "state11", to = "state2"},
            {name = "change3", from = "state2", to = "state3"},
            {name = "change3", from = "state7", to = "state3"},
            {name = "change4", from = "state2", to = "state4"},
            {name = "change4", from = "state7", to = "state4"},
            {name = "change6", from = "state2", to = "state6"},
            {name = "change6", from = "state4", to = "state6"},
            {name = "change6", from = "state6", to = "state6"},
            {name = "change6", from = "state11", to = "state6"},
            {name = "change7", from = "state4", to = "state7"},
            {name = "change7", from = "state7", to = "state7"},
            {name = "change11", from = "state2", to = "state11"},
            {name = "change11", from = "state11", to = "state11"},
        -- {name = "change", from = "state", to = "state"},
        -- {name = "change", from = "state", to = "state"},
        },
        callbacks = {
            onbeforechange1 = function(event)
                lgyPrint("onbeforechange1")
                if event.from == "state2" then
                    self.eqUse.gameObject:SetActive(false)
                    self.eqShuXingBg.gameObject:SetActive(true)
                elseif event.from == "state3" then
                    self.roleShuXing.gameObject:SetActive(false)
                    self.eqShuXingBg.gameObject:SetActive(true)
                elseif event.from == "state4" then
                    self.bg3.gameObject:SetActive(false)
                    self.eqUse.gameObject:SetActive(false)
                    self.eqShuXingBg.gameObject:SetActive(true)
                elseif event.from == "state11" then
                    self.bg4.gameObject:SetActive(false)
                    self.eqUse.gameObject:SetActive(false)
                    self.eqShuXingBg.gameObject:SetActive(true)
                end
                self.bg5.gameObject:SetActive(false)
                local i = event.args[1]
                if i then
                    eqInfoType = i
                    self.nowEqBgEqSpr.gameObject:SetActive(true)
                    self.nowEqBgLevel.gameObject:SetActive(true)
                    
                    self:setEqView(1, equipP.nowEqList[i])
                end
            end,
            onbeforechange2 = function(event)
                lgyPrint("onbeforechange2")
                
                if event.from == "state1" then
                    self.eqUse.gameObject:SetActive(true)
                    self.eqShuXingBg.gameObject:SetActive(false)
                elseif event.from == "state3" then
                    self.eqUse.gameObject:SetActive(true)
                    self.roleShuXing.gameObject:SetActive(false)
                elseif event.from == "state4" then
                    self.bg3.gameObject:SetActive(false)
                elseif event.from == "state6" then
                    self.bg3.gameObject:SetActive(false)
                    self.bg4.gameObject:SetActive(false)
                elseif event.from == "state11" then
                    self.bg4.gameObject:SetActive(false)
                end
                self.bg5.gameObject:SetActive(false)
                local i = event.args[1]
                if i then
                    eqChangeType = i
                    if equipP.nowEqList[i] == 0 then --如果点的是空的装备栏
                        self.xiexia.gameObject:SetActive(false)
                    else
                        self.xiexia.gameObject:SetActive(true)
                    end
                    self:setEQUse(i)
                end
            
            end,
            onbeforechange3 = function(event)
                lgyPrint("onbeforechange3")
                if event.from == "state2" then
                    self.eqUse.gameObject:SetActive(false)
                    self.roleShuXing.gameObject:SetActive(true)
                elseif event.from == "state7" then
                    self.bg3.gameObject:SetActive(false)
                end
            end,
            onbeforechange4 = function(event)
                lgyPrint("onbeforechange4")
                if event.from == "state2" then
                    self.bg3.gameObject:SetActive(true)
                elseif event.from == "state7" then
                    self.roleShuXing.gameObject:SetActive(false)
                    self.eqUse.gameObject:SetActive(true)
                end
                self.bg5.gameObject:SetActive(false)
                local i = event.args[1]
                if i then
                    if self.eqBg[i].localPosition.x > 0 then
                        self.bg3.localPosition = Vector3(-436, self.bg3.localPosition.y, self.bg3.localPosition.z)
                    else
                        self.bg3.localPosition = Vector3(-166, self.bg3.localPosition.y, self.bg3.localPosition.z)
                    end
                    self:setEqView(2, equipP.nowEqList[i])
                end
            end,
            onbeforechange6 = function(event)
                lgyPrint("onbeforechange6")
                self.bg3.gameObject:SetActive(true)
                self.bg4.gameObject:SetActive(true)
                
                self.bg5.gameObject:SetActive(false)
                self.bg3.localPosition = Vector3(-436, self.bg3.localPosition.y, self.bg3.localPosition.z)
                self.bg4.localPosition = Vector3(55, self.bg4.localPosition.y, self.bg4.localPosition.z)
                
                local i = event.args[1]
                local v = event.args[2]
                if i then
                    self:setEqView(2, equipP.nowEqList[i])
                    self:setEqView(3, v)
                end
            end,
            onbeforechange7 = function(event)
                lgyPrint("onbeforechange7")
                if event.from == "state4" then
                    self.roleShuXing.gameObject:SetActive(true)
                    self.eqUse.gameObject:SetActive(false)
                elseif event.from == "state7" then
                    end
            
            end,
            onbeforechange11 = function(event)
                lgyPrint("onbeforechange11")
                self.bg4.gameObject:SetActive(true)
                self.bg4.localPosition = Vector3(-117, self.bg4.localPosition.y, self.bg4.localPosition.z)
                self.bg5.gameObject:SetActive(false)
                local v = event.args[1]
                if v then
                    self:setEqView(3, v)
                end
            end,
            onchangestate = function(event)lgyPrint("onchangestate") end
        }
    })
    
    
    
    local tempCount = 0 ----如果一件穿戴着的装备都没有的处理(跳转到更换装备界面)
    for i = 1, 8 do
        self.eqBg[i] = self.transform:Find("bg1/eqBg" .. i)--装备栏bg
        if equipP.nowEqList[i] == 0 then --当装备栏未穿戴任何装备
            -- self.eqBg[i]:GetComponent(typeof(UISprite)).spriteName = "pz_0" .. 7
            -- self.eqBg[i]:Find("eqSpr").gameObject:SetActive(false)
            -- self.eqBg[i]:Find("level").gameObject:SetActive(false)
            ZUOCEZHUANGBEI(1, i)
        else --当装备栏穿戴了装备
            if tempCount == 0 then --只要穿了一件装备，右侧装备详情信息不为空，且为第一个不为空的装备信息
                tempCount = tempCount + 1
                eqInfoType = i
                self:setEqView(1, equipP.nowEqList[i])
            end
            setEqIconView(self.eqBg[i], equipP.nowEqList[i])
        end
        UIEventListener.Get(self.eqBg[i].gameObject).onClick = function(go)
            local _current = self.simple_state_machine._current
            if _current == "state1" then
                if equipP.nowEqList[i] == 0 then --如果点的是空的装备栏
                    self.simple_state_machine:do_event("change2", i)
                else
                    self.simple_state_machine:do_event("change1", i)
                end
            elseif _current == "state2" then
                if equipP.nowEqList[i] == 0 then --如果点的是空的装备栏
                    self.simple_state_machine:do_event("change2", i)
                elseif eqChangeType == i then
                    self.simple_state_machine:do_event("change4", i)
                else
                    self.simple_state_machine:do_event("change1", i)
                end
            elseif _current == "state3" then
                self.simple_state_machine:do_event("change1", i)
            elseif _current == "state4" then
                if equipP.nowEqList[i] == 0 then --如果点的是空的装备栏
                    self.simple_state_machine:do_event("change2", i)
                elseif eqChangeType ~= i then
                    self.simple_state_machine:do_event("change1", i)
                end
            elseif _current == "state7" then
                if eqChangeType == i then --如果点的是右侧展示的装备类型
                    self.simple_state_machine:do_event("change7", i)
                else
                    self.simple_state_machine:do_event("change1", i)
                end
            elseif _current == "state11" then
                if equipP.nowEqList[i] == 0 then --如果点的是空的装备栏
                    self.simple_state_machine:do_event("change2", i)
                else
                    self.simple_state_machine:do_event("change1", i)
                end
            end
        end
    end
    
    if tempCount == 0 then ----如果一件穿戴着的装备都没有的处理(跳转到更换装备界面)
        self.simple_state_machine:do_event("change2", 1)
    end
    
    
    if tempCount == 0 then --如果一件穿戴着的装备都没有的处理(右侧装备详情信息为空)
        self.nowEqBgEqSpr.gameObject:SetActive(false)
        self.nowEqBgLevel.gameObject:SetActive(false)
    end
    
    
    UIEventListener.Get(self.back1.gameObject).onClick = function(go)
        ui_manager:ShowWB(WND.Login)
    end
    UIEventListener.Get(self.back2.gameObject).onClick = function(go)
        end
    UIEventListener.Get(self.info.gameObject).onClick = function(go)--详情按钮
            --TODODO
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            -- equipP.add_allEqList(1, equipM(1, 10001, 1, 6, 0, 10001, {equipShuXingM(10025, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0), equipShuXingM(10037, 1, 0)}))
            --TODODO
            local value = equipP.allEqList[1][4]
            value.IsBad = 0
            equipP.change_allEqList(1, 4, value)
    --TODODO
    -- local t = os.clock()
    -- local a = {100, 200, 300, 400}
    -- for i = 1, 10000000 do
    --     -- local a, b, c, d = a[1],a[2],a[3],a[4]
    --     local a, b, c, d = unpack(a)
    -- end
    -- lgyPrint((os.clock() - t) .. "")
    --TODODO
    -- local value = equipP.nowEqList[1]
    -- value.QiangHuaLevel = value.QiangHuaLevel + 1
    -- equipP.change_nowEqList(1, value)
    -- if self.eqShuXingBg.gameObject.activeSelf then
    --     self.simple_state_machine:do_event("change1")
    -- else
    --     self.simple_state_machine:do_event("change2")
    -- end
    -- self:setAllInfo()
    -- self.bg5.gameObject:SetActive(true)
    end
    UIEventListener.Get(self.shizhuang.gameObject).onClick = function(go)
        end
    UIEventListener.Get(self.yjzb.gameObject).onClick = function(go)
        end
    UIEventListener.Get(self.fenxiang.gameObject).onClick = function(go)
        end
    UIEventListener.Get(self.genghuan.gameObject).onClick = function(go)
        if self.simple_state_machine._current == "state1" then
            self.simple_state_machine:do_event("change2", eqInfoType)
        end
    end
    UIEventListener.Get(self.suoding.gameObject).onClick = function(go)
        end
    UIEventListener.Get(self.eqShuXingXieXia.gameObject).onClick = function(go)
        equipP.add_allEqListOfXieXia(eqInfoType, equipP.nowEqList[eqInfoType])
        equipP.remove_nowEqList(eqInfoType)
        self.simple_state_machine:do_event("change2", eqInfoType)--跳转到更换装备界面
    end
    UIEventListener.Get(self.xiexia.gameObject).onClick = function(go)
        self.xiexia.gameObject:SetActive(false)
        equipP.add_allEqListOfXieXia(eqChangeType, equipP.nowEqList[eqChangeType])
        equipP.remove_nowEqList(eqChangeType)
    end
    UIEventListener.Get(self.bg4genghuan.gameObject).onClick = function(go)
        local v = equipP.allEqList[eqChangeType][eqChangeIndex]
        if equipP.nowEqList[eqChangeType] == 0 then --如果装备栏上没有装备
            equipP.add_nowEqList(eqChangeType, v)
            equipP.remove_allEqList(eqChangeType, v)
        else
            equipP.exchange_EqList(eqChangeType, equipP.nowEqList[eqChangeType], v)
        end
        
        self.simple_state_machine:do_event("change2")
    end
    UIEventListener.Get(self.battleWidget.gameObject).onPress = function(go, args)
        if args then
            if self.battleWidget.depth == -99 then
                self:dianjikongbai()
            end
        end
    end
    
    UIEventListener.Get(self.qianghua.gameObject).onClick = function(go)
        iseqShuXingBg = true
        ui_manager:ShowWB(WND.ui_chongzhu)
    --TODODO 直接重铸
    -- local v = equipP.nowEqList[eqInfoType]
    -- local maxLevel = (v.EquipQuality - 1) * 3
    -- if v.IsBad == 1 then --修理
    --     elseif maxLevel == v.QiangHuaLevel then --重铸
    --     else --强化
    --         end
    end
    
    UIEventListener.Get(self.bg4Qianghua.gameObject).onClick = function(go)
        iseqShuXingBg = false
        ui_manager:ShowWB(WND.ui_chongzhu)
    --TODODO 直接重铸
    -- local v = equipP.allEqList[eqChangeType][eqChangeIndex]
    -- local maxLevel = (v.EquipQuality - 1) * 3
    -- if v.IsBad == 1 then --修理
    --     elseif maxLevel == v.QiangHuaLevel then --重铸
    --     else --强化
    --         end
    end
    
    UIEventListener.Get(self.eqUse.gameObject).onPress = function(go, args)
        if args then
            self.simple_state_machine:do_event("change2")--跳转到更换装备界面
        end
    end
    
    UIEventListener.Get(playerModelTexture.gameObject).onPress = function(go, args)
        if args then
            self:dianjikongbai()
        end
    end
end

function ui_equip:dianjikongbai()
    local _current = self.simple_state_machine._current
    if _current == "state4" or _current == "state6" or _current == "state11" then
        self.simple_state_machine:do_event("change2")
    elseif _current == "state7" then
        self.simple_state_machine:do_event("change3")
    end
    self.bg5.gameObject:SetActive(false)
end

--设置更换装备界面显示，i为装备类型
function ui_equip:setEQUse(i)
    --删掉之前的obj i不从0开始因为卸下按钮
    for i = 1, self.eqGrid.childCount - 1 do
        local child = self.eqGrid:GetChild(i)
        Object.Destroy(child.gameObject)
    end
    
    --如果卸下按钮隐藏startX = 1
    local startX = self.xiexia.gameObject.activeSelf and 0 or 1
    if #equipP.allEqList[i] ~= 0 then
        self.ceqTB = {}
        for j, v in ipairs(equipP.allEqList[i]) do
            local go = GameObjectExtension.InstantiateFromPacket("ui_equip", "eqBg", self.eqGrid.gameObject)
            setEqIconView(go.transform, v)
            self.ceqTB[#self.ceqTB + 1] = go.transform
            --装备排列
            go.transform.localPosition = Vector3((j - startX) % self.eqUIGridMPL * self.eqUIGridCW, -math.modf((j - startX) / self.eqUIGridMPL) * self.eqUIGridCH, 0)
            
            --装备添加触摸
            UIEventListener.Get(go).onClick = function(go)
                eqChangeIndex = table.indexof(equipP.allEqList[i], v)
                if equipP.nowEqList[i] == 0 then --如果对应的装备栏为空
                    self.simple_state_machine:do_event("change11", v)
                else
                    self.simple_state_machine:do_event("change6", i, v)
                end
            end
        end
    end
end

function ui_equip:setAllInfo()
    for i = 0, self.bg5SV.childCount - 1 do
        local child = self.bg5SV:GetChild(i)
        Object.Destroy(child.gameObject)
    end
    local lp = Vector3(0, 370, 0)
    local height = 0
    local v
    local tf
    local ul
    for i = 1, #equipP.nowEqList do
        v = equipP.nowEqList[i]
        if v ~= 0 then
            --显示主属性
            tf = GameObjectExtension.InstantiateFromPacket("ui_equip", "shuxing", self.bg5SV.gameObject).transform
            ul = tf:GetComponent(typeof(UILabel))
            ul.text = sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, v.MainEffectID) .. "+" .. sdata_EquipPlan_data[sdata_Equip_data:GetV(sdata_Equip_data.I_MainEffect, v.EquipID)][v.MainEffectID].up .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, v.MainEffectID)
            ul.color = mainColor
            tf.localPosition = Vector3(lp.x, lp.y - height - 19, lp.z)
            height = ul.height
            lp = tf.localPosition
            
            --显示附加属性
            for j, v in ipairs(v.ViceEffect) do
                tf = GameObjectExtension.InstantiateFromPacket("ui_equip", "shuxing", self.bg5SV.gameObject).transform
                ul = tf:GetComponent(typeof(UILabel))
                ul.text = sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, v.ShuXingID) .. "+" .. v.ShuXingNum .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, v.ShuXingID)
                ul.color = fuJiaColor
                tf.localPosition = Vector3(lp.x, lp.y - height - 19, lp.z)
                height = ul.height
                lp = tf.localPosition
            end
        end
    end
    
    
    local str = sdata_UILiteral:GetV(sdata_UILiteral.I_Literal, 10002)
    local effectID
    for k, v in pairs(self.suitData) do
        if v > 1 then --2件套属性
            effectID = sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_SuitEffect2, k)
            tf = GameObjectExtension.InstantiateFromPacket("ui_equip", "shuxing", self.bg5SV.gameObject).transform
            ul = tf:GetComponent(typeof(UILabel))
            ul.text = string.gsub(str, "#N", 2) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, effectID) .. "+" .. sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_Effect2Point, k) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, effectID)
            ul.color = suitColor
            tf.localPosition = Vector3(lp.x, lp.y - height - 19, lp.z)
            height = ul.height
            lp = tf.localPosition
        end
        if v > 2 then --3件套属性
            effectID = sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_SuitEffect3, k)
            tf = GameObjectExtension.InstantiateFromPacket("ui_equip", "shuxing", self.bg5SV.gameObject).transform
            ul = tf:GetComponent(typeof(UILabel))
            ul.text = string.gsub(str, "#N", 3) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, effectID) .. "+" .. sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_Effect3Point, k) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, effectID)
            ul.color = suitColor
            tf.localPosition = Vector3(lp.x, lp.y - height - 19, lp.z)
            height = ul.height
            lp = tf.localPosition
        end
        if v > 4 then --5件套属性
            effectID = sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_SuitEffect5, k)
            tf = GameObjectExtension.InstantiateFromPacket("ui_equip", "shuxing", self.bg5SV.gameObject).transform
            ul = tf:GetComponent(typeof(UILabel))
            ul.text = string.gsub(str, "#N", 5) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, effectID) .. "+" .. sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_Effect5Point, k) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, effectID)
            ul.color = suitColor
            tf.localPosition = Vector3(lp.x, lp.y - height - 19, lp.z)
            height = ul.height
            lp = tf.localPosition
        end
    end
end



--设置装备图标显示 tf为transform v为详情table
function setEqIconView(tf, v)
    tf:GetComponent(typeof(UISprite)).spriteName = "pz_0" .. v.EquipQuality
    local sprite = tf:Find("eqSpr"):GetComponent(typeof(UISprite))
    tf:Find("eqSpr"):GetComponent(typeof(UISprite)).spriteName = sdata_Equip_data:GetV(sdata_Equip_data.I_EquipResName, v.EquipID)
    if v.IsBad == 1 then
        sprite.color = badColor
    else
        sprite.color = Color(1, 1, 1, 1)
    end
    tf:Find("level"):GetComponent(typeof(UILabel)).text = "lv" .. v.QiangHuaLevel
end

--设置装备详情显示 v为详情table
function ui_equip:setEqView(i, v)
    self.bgShuXing[i].EqSprSprite.spriteName = sdata_Equip_data:GetV(sdata_Equip_data.I_EquipResName, v.EquipID)
    if v.IsBad == 1 then
        self.bgShuXing[i].EqSprSprite.color = badColor
    else
        self.bgShuXing[i].EqSprSprite.color = Color(1, 1, 1, 1)
    end
    self.bgShuXing[i].EqBgSprSprite.spriteName = "pz_0" .. v.EquipQuality
    self.bgShuXing[i].EQLevelLabel.text = "lv" .. v.QiangHuaLevel
    self.bgShuXing[i].eqName.text = sdata_Equip_data:GetV(sdata_Equip_data.I_EquipName, v.EquipID)
    
    
    --设置主属性
    self.bgShuXing[i].shuxingMain.text = sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, v.MainEffectID) .. "+" .. sdata_EquipPlan_data[sdata_Equip_data:GetV(sdata_Equip_data.I_MainEffect, v.EquipID)][v.MainEffectID].up .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, v.MainEffectID)
    
    
    --设置附加属性
    for j, v in ipairs(v.ViceEffect) do
        self.bgShuXing[i]["shuxingFuJia" .. j].enabled = true
        self.bgShuXing[i]["shuxingFuJia" .. j .. "SuoSpr"].gameObject:SetActive(false)
        self.bgShuXing[i]["shuxingFuJia" .. j].text = sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, v.ShuXingID) .. "+" .. v.ShuXingNum .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, v.ShuXingID)
    end
    local str = sdata_UILiteral:GetV(sdata_UILiteral.I_Literal, 10001)
    for j = #v.ViceEffect + 1, v.EquipQuality - 1 do
        self.bgShuXing[i]["shuxingFuJia" .. j].enabled = true
        self.bgShuXing[i]["shuxingFuJia" .. j .. "SuoSpr"].gameObject:SetActive(false)
        self.bgShuXing[i]["shuxingFuJia" .. j].text = string.gsub(str, "#N", tostring(j * 3))
    end
    for j = v.EquipQuality, 5 do
        self.bgShuXing[i]["shuxingFuJia" .. j].enabled = false
        self.bgShuXing[i]["shuxingFuJia" .. j .. "SuoSpr"].gameObject:SetActive(true)
    end
    
    --设置套装属性
    local suitID = sdata_Equip_data:GetV(sdata_Equip_data.I_SuitID, v.EquipID)
    local effectID2 = sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_SuitEffect2, suitID)
    local effectID3 = sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_SuitEffect3, suitID)
    local effectID5 = sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_SuitEffect5, suitID)
    
    str = sdata_UILiteral:GetV(sdata_UILiteral.I_Literal, 10002)
    self.bgShuXing[i]["shuxingSuit" .. 1].text = string.gsub(str, "#N", 2) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, effectID2) .. "+" .. sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_Effect2Point, suitID) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, effectID2)
    self.bgShuXing[i]["shuxingSuit" .. 2].text = string.gsub(str, "#N", 3) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, effectID3) .. "+" .. sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_Effect3Point, suitID) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, effectID3)
    self.bgShuXing[i]["shuxingSuit" .. 3].text = string.gsub(str, "#N", 5) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_EffectName, effectID5) .. "+" .. sdata_Equip_suit_data:GetV(sdata_Equip_suit_data.I_Effect5Point, suitID) .. sdata_EffectName_data:GetV(sdata_EffectName_data.I_Symbol, effectID5)
    
    local lp = self.bgShuXing[i]["shuxingSuit" .. 2].transform.localPosition
    self.bgShuXing[i]["shuxingSuit" .. 2].transform.localPosition = Vector3(lp.x, self.bgShuXing[i]["shuxingSuit" .. 1].transform.localPosition.y - self.bgShuXing[i]["shuxingSuit" .. 1].height - 19, lp.z)
    lp = self.bgShuXing[i]["shuxingSuit" .. 3].transform.localPosition
    self.bgShuXing[i]["shuxingSuit" .. 3].transform.localPosition = Vector3(lp.x, self.bgShuXing[i]["shuxingSuit" .. 2].transform.localPosition.y - self.bgShuXing[i]["shuxingSuit" .. 1].height - 19, lp.z)
    
    if self.suitData[suitID] == nil then
        self.suitData[suitID] = 0
    end
    local tempInt = self.suitData[suitID]--已穿戴套装件数
    if i == 3 then
        local isAdd = true
        if equipP.nowEqList[eqChangeType] ~= 0 then
            local suitID2 = sdata_Equip_data:GetV(sdata_Equip_data.I_SuitID, equipP.nowEqList[eqChangeType].EquipID)
            if suitID == suitID2 then
                isAdd = false
            end
        end
        if isAdd then
            tempInt = tempInt + 1
        end
    end
    if tempInt > 1 then --2件套属性
        self.bgShuXing[i]["shuxingSuit" .. 1].color = suitColor
    else
        self.bgShuXing[i]["shuxingSuit" .. 1].color = Color.gray
    end
    if tempInt > 2 then --3件套属性
        self.bgShuXing[i]["shuxingSuit" .. 2].color = suitColor
    else
        self.bgShuXing[i]["shuxingSuit" .. 2].color = Color.gray
    end
    if tempInt > 4 then --5件套属性
        self.bgShuXing[i]["shuxingSuit" .. 3].color = suitColor
    else
        self.bgShuXing[i]["shuxingSuit" .. 3].color = Color.gray
    end
    
    --设置强化按钮
    local qianghua
    local jiageUL
    local maxLevel = (v.EquipQuality - 1) * 3
    if maxLevel == 0 then
        maxLevel = -1
    end
    if i ~= 2 then
        if i == 1 then
            qianghua = self.qianghua
            jiageUL = self.qianghuaJiaGeUL
        else
            qianghua = self.bg4Qianghua
            jiageUL = self.bg4QianghuaJiaGeUL
        end
        
        if v.IsBad == 1 then --修理
            qianghua:Find("title"):GetComponent(typeof(UILabel)).text = sdata_UILiteral:GetV(sdata_UILiteral.I_Literal, 10005)
        elseif maxLevel == v.QiangHuaLevel then --重铸
            qianghua:Find("title"):GetComponent(typeof(UILabel)).text = sdata_UILiteral:GetV(sdata_UILiteral.I_Literal, 10004)
        else --强化
            qianghua:Find("title"):GetComponent(typeof(UILabel)).text = sdata_UILiteral:GetV(sdata_UILiteral.I_Literal, 10003)
            if v.EquipQuality == 1 then --品质1不可强化
                jiageUL.text = "0"
            else
                jiageUL.text = v.QiangHuaLevel * 100
            end
        end
    end
end


function ui_equip:setSuitData()
    self.suitData = {}--当前穿戴套装数据
    for i = 1, #equipP.nowEqList do
        if equipP.nowEqList[i] ~= 0 then
            local suitID = sdata_Equip_data:GetV(sdata_Equip_data.I_SuitID, equipP.nowEqList[i].EquipID)
            if self.suitData[suitID] == nil then
                self.suitData[suitID] = 0
            end
            self.suitData[suitID] = self.suitData[suitID] + 1
        end
    end
end


--装备的排序规则：装备损坏程度>装备品质>装备强化等级>随机排序，按以上层级，由高到低排序
function sortEqList(i)
    table.sort(equipP.allEqList[i], function(ta, tb)
        if ta.IsBad == tb.IsBad then
            if ta.EquipQuality == tb.EquipQuality then
                return ta.QiangHuaLevel > tb.QiangHuaLevel
            else
                return ta.EquipQuality > tb.EquipQuality
            end
        else
            return ta.IsBad < tb.IsBad
        end
    end)
end

function ui_equip:OnDestroyDoneEnd()
    self.myTexture:Release()
end

function ui_equip:OnAddHandler()
    --注册玩家下兵事件
    Event.AddListener(GameEventType.ZUOCEZHUANGBEI, ZUOCEZHUANGBEI)
    Event.AddListener(GameEventType.YOUCEZHUANGBEI, YOUCEZHUANGBEI)
    Event.AddListener(GameEventType.EXCHANGEZHUANGBEI, EXCHANGEZHUANGBEI)
end
function ui_equip:OnRemoveHandler()
    Event.RemoveListener(GameEventType.ZUOCEZHUANGBEI, ZUOCEZHUANGBEI)
    Event.RemoveListener(GameEventType.YOUCEZHUANGBEI, YOUCEZHUANGBEI)
    Event.RemoveListener(GameEventType.EXCHANGEZHUANGBEI, EXCHANGEZHUANGBEI)
end
return ui_equip
