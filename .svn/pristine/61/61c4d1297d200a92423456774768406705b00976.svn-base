local wnd_tuiguanClass = class(wnd_base)

wnd_tuiguan = nil--单例

TuiGuanGiveUpType = {
    TuiGuan = 0,
    FightWin = 1,
}

TuiGuanEnum = {
    Normal = 0,     --普通模式
    Hard = 1,       --难度模式
}
--省状态
local ProvincesState = {

    Unlock = 1, --已解锁
    Locked = 2, --未解锁
    Attack = 3, --攻打中
    Occupy = 4, --已占领
    Betray = 5, --暴乱
    
}

--省信息表 包括当前状态
local ProvincesInfo = {
    {ID = 1,State = 2}
}
local TuiGuanMixed = {
    CurrentAttackMission = 0,       --当前关
    CurrentWinMission = 0,          --最高纪录
    NextMission = 0,                --下一关

    ReadyFightMission = 0,          --备战选择的关
    TreasureType = 0,
    TreasureID= 0,
    RecuritID = 0,                  --关卡结束后可招募武将的ID，0为没有
    isWin = 1,                    --战斗结果

    isNeedCreate = true,           --是否需要创建
    isLostInstance = true,          --是否丢失实例

    GiveUpType = 0,                 --放弃推关

    OpenProvince = 1,               --开放的省

    isAlreadyRandomCard = false,    --是否随机出手牌
    isJustWin = false,              --是否刚刚出战场
}
local TuiGuanCitysShadow = {}
local TuiGuanCitys = {}
local TuiGuanProvinces = {}

local TuiGuanTreasure = {}
local TuiGuanTreasureItem = {}
local TuiGuanProvinceTreasure = {}

function wnd_tuiguanClass:Start() 
	wnd_tuiguan = self
	self:Init(WND.Tuiguan)
    Battlefield.OnFightEnd():AddCallback(self,self.OnFightEnd)
    QKUIQuad.OnClick():AddCallback(self,self.OnCloudClick)
    EventHandles.OnTopWndChanged:AddListener(self,self.OnTopWndChanged)
	self.bIslistenmoney = false --金币铜币监听标记
    self.TuiGuanClouds = {}
    self.TuiGuanBaoXiang = nil;
end
ZhuCheng = {
	PlayerInfo = 1,
	PaiHang = 2,
	Mail = 3,
	ChouJiang = 4,
	ChongZhi = 5,
	PaiKu = 6,
	Hero = 7,
    BuyHero = 8,
}
--窗体被实例化时被调用
--初始化实例
function wnd_tuiguanClass:OnNewInstance()
    self.TargetVisible = true
	self.bIsBuyhero = false
    print("wnd_tuiguanClass:OnNewInstance")
	self:BindUIEvent ("TouxiangImg", UIEventType.Click, "OnInformationClick",ZhuCheng.PlayerInfo)--玩家资料
	self:BindUIEvent ("btn_paihang", UIEventType.Click, "OnInformationClick",ZhuCheng.PaiHang)--排行榜
	self:BindUIEvent ("btn_mail", UIEventType.Click, "OnInformationClick",ZhuCheng.Mail)--邮件
	self:BindUIEvent ("btn_choujiang", UIEventType.Click, "OnInformationClick",ZhuCheng.ChouJiang)--抽奖
	self:BindUIEvent ("btn_chongzhi", UIEventType.Click, "OnInformationClick",ZhuCheng.ChongZhi)--充值
	self:BindUIEvent ("btn_paiku", UIEventType.Click, "OnInformationClick",ZhuCheng.PaiKu)--牌库
    self:BindUIEvent ("paizu_btn", UIEventType.Click, "OnInformationClick",ZhuCheng.PaiKu)--牌库

    self:BindUIEvent ("narrow", UIEventType.Click, "TestScaleBtn",0)
    self:BindUIEvent ("enlarge", UIEventType.Click, "TestScaleBtn",1)
    self.m_enlarge = self.instance:FindWidget("enlarge")

    self:BindUIEvent ("point/btn", UIEventType.Click, "JunLingBtn")
    

    self.m_BuyHeroBtn = self.instance:FindWidget("others")
    self.m_CityItem = self.instance:FindWidget("stateandcity/city/city01")
    self.m_ProvincesItem = self.instance:FindWidget("stateandcity/state/city01")    
    self.m_Rewards = self.instance:FindWidget("stateandcity/city/rewards")
    --添加云的prefab这个是暂时的，最后界面会全部都创建出来
    --self. = self.instance:FindWidget("stateandcity/cloud/cloud2")

    self.m_Treasure = self.instance:FindWidget("stateandcity/state/city01")

    self.m_CityBase = self.instance:FindWidget("stateandcity/city")
    self.m_ProvincesBase = self.instance:FindWidget("stateandcity/state")
    self.m_CurrAttackCity = self.instance:FindWidget("stateandcity/city/currentatk")
    self.m_NextCity = self.instance:FindWidget("stateandcity/city/city_state2")

    self.InScreenCm = self.m_NextCity:AddComponent("component/CMUIInScreen")
	self.InScreenCm:SetRecallFunc(self,self.AttackFlagInScreen)

    self.m_CurrAttackProvince = self.instance:FindWidget("stateandcity/state/city_state3")
    self.m_CurrAttackProvince:SetActive(true)
    self.m_NextProvince = self.instance:FindWidget("stateandcity/city/city_state4")
    self.m_NextProvince:SetActive(false)

	self.gameobj = self.instance:FindWidget("enlarge")
    self:BindTimeCount()

    self.BtnPaikuTips = self.instance:FindWidget("btn_paiku/new_tips")
    self.content = self.instance:FindWidget("content")
    self.content:AddComponent(CMUIZoomScale.Name)
    self.m_ZoomScale = self.content:GetComponent(CMUIZoomScale.Name)
    local evthandle = self.m_ZoomScale:BindEvent()
    evthandle:AddCallback(self,self.OnShiftCallBack)
    --self.m_ZoomScale:SetInfo(1000,200,-100,500,0,10)
    self.m_ZoomScale:SetInfo(1500,700,400,1100,500,30)
    self.m_ZoomScale:SetSizeInfo(5000,2000,3000,800)
    StartCoroutine(self, self.CreateAllCityUI,{})
    self:BindJunLingCount()
    self.FirstShowPaikuZhengying = 0 --用于保存当前显示的阵营

	self.bisWin = 0
    self:UpdateStaticTxt()
end

--设置红点提示
function wnd_tuiguanClass:ShowOrHidePaikuTips()
    if wnd_CardHouse:NeedToShowTuiGuanTips() then
        self.BtnPaikuTips:SetActive(true)
    else
        self:SetWidgetActive("btn_paiku/new_tips",false)
        self.BtnPaikuTips:SetActive(false)
    end
end

function wnd_tuiguanClass:OnTopWndChanged(wnd)
    
    if self.m_ZoomScale == nil then return end
    if wnd ~= nil then 
        local n = ifv(wnd == "ui_tuiguan",1,0)
        self.m_ZoomScale:SetControl(tonumber( n ))
    end
end

function wnd_tuiguanClass:IsNeedPostCard()
    print("wnd_tuiguanClass:IsNeedPostCard")
    local temp = Player:GetObjectF("ply/gkSaveFiles/0")
    if temp == nil then 
        TuiGuanMixed.isAlreadyRandomCard = false 
        return 
    end
    local isc = temp:GetValue("isC")
    local tVa = tonumber( isc )

    TuiGuanMixed.isAlreadyRandomCard = (tVa == 1)
end

function wnd_tuiguanClass:GetJustWin()
    return TuiGuanMixed.isJustWin
end

function wnd_tuiguanClass:SetJustWin(_Value)
    TuiGuanMixed.isJustWin = _Value
end


function wnd_tuiguanClass:StartJunLingTimeCount()
	if wnd_tuiguan.isVisible then 
		if self.JunLingJS > 0 then
			self.JunLingCountCm:StartCountDown(self.JunLingJS)
		end
	end
end

function wnd_tuiguanClass:AnalyseJL(jsonDoc)
    self.JunLing = tonumber (jsonDoc:GetValue("jl"))   
    self.JunLingCS = tonumber (jsonDoc:GetValue("jlcs"))   
    self.JunLingMCS = tonumber (jsonDoc:GetValue("mcs"))   
    self.JunLingJS = tonumber (jsonDoc:GetValue("junljs"))   
    self.VIPLV = 1
    self:UpdateResource()

    self:StartJunLingTimeCount()
end
function wnd_tuiguanClass:SyncJL()
    
    self.JunLing = tonumber( Player:GetAttr(PlayerAttrNames.JunLing) )
    self.JunLingCS = tonumber( Player:GetAttr(PlayerAttrNames.JunLingCS) )
    self.JunLingMCS = tonumber( Player:GetAttr(PlayerAttrNames.JunLingMCS) )
    self.JunLingJS = tonumber( Player:GetAttr(PlayerAttrNames.JunLingJS) )
    self.VIPLV = tonumber( Player:GetNumberAttr(PlayerAttrNames.CZLJCS) )

    self.JunLingB = {}
    local b = Player:GetJLBag()
	local eachFunc = function (syncObj)
        local tempinfo = {}
        local id = tonumber( syncObj:GetValue(JLBagAttrNames.DataID) )
        local num = tonumber( syncObj:GetValue(JLBagAttrNames.NUM) )
        self.JunLingB[id] = num
	end
	b:ForeachJLBag(eachFunc)

    self:StartJunLingTimeCount()
end

function wnd_tuiguanClass:BindJunLingCount()
    self.JunLingCountCm = {}
    self.JunLingCountCm = self.gameobj:AddComponent("component/CMUICountDown")
	self.JunLingCountCm:SetTextFillFunc(self,self.JunLingCountUpdate)
	self.JunLingCountCm:SetCountDownEndFunc(self,self.JunLingCountEnd)
end

function wnd_tuiguanClass:JunLingCountEnd(time_num,time_str)
    self.JunLingJS = tonumber( time_num )
	self:SendGetJLNetWork()
    --print("wnd_tuiguanClass:JunLingCountUpdate",time_num,time_str)
end

function wnd_tuiguanClass:JunLingCountUpdate(time_num,time_str)
	 self.JunLingJS = tonumber( time_num )
     --print("wnd_tuiguanClass:JunLingCountUpdate",time_num,time_str)
end

function wnd_tuiguanClass:NM_UJLBCallBack(jsonDoc)
   
    local Result = tonumber (jsonDoc:GetValue("r"))   
     print("wnd_tuiguanClass:NM_UJLBCallBack",Result)
    if Result ~= 0 then 
        print("wnd_tuiguanClass:NM_BuyJLCallBack Fail")
        return 
    end
    self:AnalyseJL(jsonDoc)
end
function wnd_tuiguanClass:SendUJLBNetWork()
    print("wnd_tuiguanClass:SendUJLBNetWork")
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","UJLB")  --使用军令包
    jsonNM:Add ("num","1")  --使用个数
    local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.NM_UJLBCallBack)  
end

function wnd_tuiguanClass:NM_BuyJLCallBack(jsonDoc)
    print("wnd_tuiguanClass:NM_BuyJLCallBack")
    local Result = tonumber (jsonDoc:GetValue("r"))   

    if Result ~= 0 then 
        print("wnd_tuiguanClass:NM_BuyJLCallBack Fail")
        return 
    end
    self:AnalyseJL(jsonDoc)
end
function wnd_tuiguanClass:SendBuyJLNetWork()
    print("wnd_tuiguanClass:SendBuyJLNetWork")
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","BJL")  --买
    local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.NM_BuyJLCallBack)  

end

function wnd_tuiguanClass:NM_GetJLCallBack(jsonDoc)
    print("wnd_tuiguanClass:NM_GetJLCallBack")
    local Result = tonumber (jsonDoc:GetValue("r"))   

    if Result ~= 0 then 
        print("wnd_tuiguanClass:NM_GetJLCallBack Fail")
        return 
    end
    --jl mcs junljs r 

    self:AnalyseJL(jsonDoc)
end
function wnd_tuiguanClass:SendGetJLNetWork()
    print("wnd_tuiguanClass:SendJLNetWork")
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GJL")  --请求军令
    local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.NM_GetJLCallBack)  
end

function wnd_tuiguanClass:FakeTween(ftime)
    local Map = self.instance:FindWidget("rotateControl/map")
    local MapCm = Map:GetComponent(CMUIScrollView.Name)
    MapCm:MoveRelative(- self.x,- self.y,0)
    self.Cursor = 1 + self.Cursor

    --print("wnd_tuiguanClass:FakeTween")
    MapCm:RestrictWithinBounds()
end

function wnd_tuiguanClass:ForceOnProvinceID(_Province)

    local tempx = sdata_MissionState:GetV(sdata_MissionState.I_MainCityPicX,_Province)
    local tempy = sdata_MissionState:GetV(sdata_MissionState.I_MainCityPicY,_Province)
    self:ForceOnCoord(tempx,tempy)

end

function wnd_tuiguanClass:ForceOnCoord(tempx,tempy)

    local Map = self.instance:FindWidget("rotateControl/map")
    local MapPanel = Map:GetComponent(CMUIPanel.Name)
    local MapCm = Map:GetComponent(CMUIScrollView.Name)
    local MapPosition = Map:GetLocalPosition()

    local Content = self.instance:FindWidget("stateandcity")
    local ContentPosition = Content:GetLocalPosition()

    local movex = tempx + MapPosition.x + ContentPosition.x
    local movey = tempy + MapPosition.y + ContentPosition.y - 350

    MapPosition.x = MapPosition.x - movex
    MapPosition.y = MapPosition.y - movey

    local Times = 20
    self.x = movex/Times
    self.y = movey/Times

    self.Cursor = 1
    for i = 1 , Times do 
        local sequencem = Sequence.new()
        sequencem:InsertCallback(i*0.3/Times,self,self.FakeTween)
    end

end

function wnd_tuiguanClass:ForceOnCityID(_CityID)

    local tempx = sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicX,_CityID)
    local tempy = sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicY,_CityID)

    self:ForceOnCoord(tempx,tempy)
    
end

function wnd_tuiguanClass:ForceOnCity()

    if self.m_FlagCity == nil then return end
    if self.m_FlagCity == 0 then return end
    if self.m_FlagCity == sdata_MissionMonster:GetFinalMission() then return end
    local ResultCityID,CAProvinceID  = sdata_MissionMonster:GetOrganization(self.m_FlagCity)
    self:ForceOnCityID(ResultCityID)    
end

function wnd_tuiguanClass:AutoZPosition()
    
    local nCity,nProvince = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentAttackMission)
    local p = self.content:GetLocalPosition()
    
    if self.ContentZ ~= nil then
        self.m_ZoomScale:Move(self.ContentZ)
    else
        self.m_ZoomScale:Move(550)
    end
end

function wnd_tuiguanClass:NM_TestJJC(_JsonDoc)
    local Result = _JsonDoc:GetValue("r")
    print("wnd_tuiguanClass:NM_TestJJC == Result:",Result)
    local Node = _JsonDoc:GetValue("Finfo")

    local structs = {}
    local structo = {}

	local Func = function(k,v)
        local temp = {}
        temp.Zid = v:GetValue("zid")
        temp.Type = ifv(k == "1",ArmyFlag.Attacker,ArmyFlag.Defender)
        temp.Heros = {}
        for i = 1,5 do 
            local vs = v:GetValue(tostring( i ))
            local sTab = {}
            sTab.Fid = tonumber(i)
            sTab.HeroID = vs:GetValue("HeroID")
            sTab.HeroLv = vs:GetValue("HeroLv")
            sTab.HeroStar = vs:GetValue("HeroStar")
            sTab.ArmyStar = vs:GetValue("ArmyStar")
            sTab.ArmyNum = vs:GetValue("ArmyNum")
            sTab.SkillLv = vs:GetValue("SkillLv")
            sTab.HeroWuqi = vs:GetValue("HeroWuqi")
            sTab.HeroHuajia = vs:GetValue("HeroHuajia")
            if tonumber( sTab.HeroID ) == 0 then 
                
            else
                table.insert(temp.Heros,sTab)
            end
        end

        if k == "1" then structs = temp
        else structo = temp
        end 
    end
    Node:Foreach(Func)

    self.TestJJC_s = structs
    self.TestJJC_o = structo

    self:JJCEnterFight()
end

function wnd_tuiguanClass:TestJJCHero(SquareList,_Tab)
    for k,v in pairs(_Tab.Heros) do

        local armySquareInfo = ArmySquareInfo.new()--创建方阵实例
        armySquareInfo:SetFlag(_Tab.Type)
        armySquareInfo:SetFID(tonumber( v.Fid ))
        armySquareInfo:SetHeroID(tonumber( v.HeroID ))
        armySquareInfo:SetHeroLevel(tonumber( v.HeroLv ))
        armySquareInfo:SetHXJ(tonumber( v.HeroStar ))
        armySquareInfo:SetHP(-1)
        armySquareInfo:SetSXJ(tonumber( v.ArmyStar ))
        armySquareInfo:SetSoldiersCount(tonumber( v.ArmyNum ))
        
        local Equips = {}
        print("wnd_tuiguanClass:TestJJCHero ===== 1 ==",v.HeroWuqi)
        local Weapons = string.split(v.HeroWuqi,"|")
        if v.HeroWuqi ~= "0" then
            local wuqi = Equip.new()--创建武器实例
            wuqi:SetStaticID(tonumber( Weapons[1] ))--设置装备数据ID
            wuqi:SetXilianST(tonumber( Weapons[2] ))--设置装备洗练状态
            table.insert(Equips,wuqi)
        end
        print("wnd_tuiguanClass:TestJJCHero ===== 2 ==",v.HeroHuajia)
        local Armors = string.split(v.HeroHuajia,"|")
        if v.HeroHuajia ~= "0" then
            local hujia = Equip.new()--创建护甲实例
            hujia:SetStaticID(tonumber( Armors[1] ))--设置装备数据ID
            hujia:SetXilianST(tonumber( Armors[2] ))--设置装备洗练状态
            table.insert(Equips,hujia)
        end
        armySquareInfo:SetEquips(Equips)--装备队列放入军队方阵中
        print("wnd_tuiguanClass:TestJJCHero ===== 3 ==",v.HeroHuajia)
        local Skills = string.split(v.SkillLv,"|")
            local ResultSk = {}
            ResultSk[1] = 1
            ResultSk[6] = 0
            for i = 2,5 do 
                ResultSk[i] = tonumber(Skills[i-1])
            end
        armySquareInfo:SetSkillLevels(ResultSk)
        print("wnd_tuiguanClass:TestJJCHero ===== 4 == ",v.SkillLv)
        table.insert(SquareList,armySquareInfo)
    end
end

function wnd_tuiguanClass:RandomEventEnterFight(_Structs,_Structo)

    local BattleParmaInstance =  FightParameter.new()--创建战斗参数对象
    BattleParmaInstance:SetLeftZhenfaID(tonumber( _Structs.Zid ))--设置左阵法
    BattleParmaInstance:SetRightZhenfaID(tonumber( _Structo.Zid))--设置右阵法
    local MapID = tonumber( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MapID,101) )
    BattleParmaInstance:SetSceneID(MapID)--设置场景ID
    local Music = tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_Music,101) )
    BattleParmaInstance:SetMusic(Music)--设置背景音
    local SquareList = {}
    self:TestJJCHero(SquareList,_Structs)
    self:TestJJCHero(SquareList,_Structo)
    BattleParmaInstance:SetSquares(SquareList)--阵容队列放进战斗参数
    Wnd.HideAll()--隐藏所有界面
    Battlefield.StartFight(BattleParmaInstance)

    self.FightType = "RandomEvent"
end

function wnd_tuiguanClass:JJCEnterFight()

    local BattleParmaInstance =  FightParameter.new()--创建战斗参数对象
    BattleParmaInstance:SetLeftZhenfaID(tonumber( self.TestJJC_s.Zid ))--设置左阵法
    BattleParmaInstance:SetRightZhenfaID(tonumber( self.TestJJC_o.Zid))--设置右阵法
    local MapID = tonumber( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MapID,101) )
    BattleParmaInstance:SetSceneID(MapID)--设置场景ID
    local Music = tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_Music,101) )
    BattleParmaInstance:SetMusic(Music)--设置背景音
    local SquareList = {}
    self:TestJJCHero(SquareList,self.TestJJC_s)
    self:TestJJCHero(SquareList,self.TestJJC_o)
    BattleParmaInstance:SetSquares(SquareList)--阵容队列放进战斗参数
    Wnd.HideAll()--隐藏所有界面
    Battlefield.StartFight(BattleParmaInstance)

    self.FightType = "TestJJC"
end

function wnd_tuiguanClass:TestJJC( _Str )
    local NM = QKJsonDoc.NewMap()
    NM:Add("n","dbgcmd")
    NM:Add("debug",_Str)--Nbjjc;1
    local loader = GameConn:CreateLoader(NM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.NM_TestJJC)
end

function wnd_tuiguanClass:JunLingBuyTest(id)
    print("wnd_tuiguanClass:JunLingBuyTest",id)
    if id == 2 then
        local cost = tonumber( sdata_KeyValueMath:GetV(sdata_KeyValueMath.I_LingGoldPrice,self.JunLingCS + 1) )
        local Gold = tonumber( Player:GetNumberAttr(PlayerAttrNames.Gold) )
        if Gold >= cost then
            self:SendBuyJLNetWork()
        else
			Poptip.PopMsg("资源不足~",Color.red)
            --MsgBox.Show("是否前往充值","否","是",self,self.JunLingToShop)临时
        end
    else
        
    end
end 

function wnd_tuiguanClass:JunLingToShop(id)
    print("wnd_tuiguanClass:JunLingToShop",id)
    if id == 2 then
        wnd_chongzhi:Show()
    else
        
    end
end 

function wnd_tuiguanClass:JunLingBag(id)
    print("wnd_tuiguanClass:JunLingBag",id) --id：2 True  --id：1 False
    if id == 2 then
        self:SendUJLBNetWork()  --使用军令包
    else
        print("wnd_tuiguanClass:JunLingBag",self.JunLingCS,self.JunLingMCS)
        if self.JunLingCS >= self.JunLingMCS then --是否达到购买上限
            if self.VIPLV >= 14 then    --是否VIP还能提升
                Poptip.PopMsg("今日购买军令次数已达上限")
            else
                 MsgBox.Show("今日购买军令次数是已达上限，提升VIP等级可增加购买上限。是否前往充值","否","是",self,self.JunLingToShop)
            end
        else
            local take = sdata_keyvalue:GetV(sdata_keyvalue.I_BuyLingNum,1)
            local cost = sdata_KeyValueMath:GetV(sdata_KeyValueMath.I_LingGoldPrice,self.JunLingCS + 1)
            MsgBox.Show("是否花费"..tostring( cost ).."金币购买".. tostring( take ).."军令","否","是",self,self.JunLingBuyTest)
        end
    end     
end


function wnd_tuiguanClass:JunLingBtn()

    print("wnd_tuiguanClass:JunLingBtn",sdata_JunlingbaoData)

    local isHave = false
    local each_func = function(key,row)
        local intKey = tonumber(key)
		local temp = self.JunLingB[intKey]
        if temp ~= nil then
            isHave = true
        end
	end
	sdata_JunlingbaoData:Foreach(each_func) 



    if isHave then
        MsgBox.Show("当前有军令包，是否使用？","否","是",self,self.JunLingBag)
    else
        self:JunLingBag(1)
    end
end 

function wnd_tuiguanClass:TestScaleBtn(obj,islarge)
    print("wnd_tuiguan:TestScaleBtn islarge:",islarge)
    if islarge == 0 then
        --切换
        self.m_ZoomScale:OnShift()
    else
        --
        self:ForceOnCity()
    end
end

function wnd_tuiguanClass:ShiftDelay() 
    local isLarge = self.m_ZoomScale:GetZoomState()

    self.m_CityBase:SetActive(not isLarge)
    self.m_ProvincesBase:SetActive(isLarge)
end
--切换镜头深度的回调函数   
function wnd_tuiguanClass:OnShiftCallBack(_) 
    local isLarge = self.m_ZoomScale:GetZoomState()

    local CTween = self.m_CityBase:GetComponent(CMUITweener.Name)
    local PTween = self.m_ProvincesBase:GetComponent(CMUITweener.Name)

    local sequencem = Sequence.new()
    sequencem:InsertCallback(0.2,self,self.ShiftDelay)

    if isLarge then
        PTween:PlayForward()
        CTween:PlayReverse()
    else
        PTween:PlayReverse()
        CTween:PlayForward()
    end    
    self.m_CurrAttackProvince:SetActive(isLarge)
    self.m_BuyHeroBtn:SetActive(isLarge~=true)
end

function wnd_tuiguanClass:ReadyFight(SelectMission) 
    TuiGuanMixed.ReadyFightMission = SelectMission
    QY2LessonManager.SetGuanQiaID(TuiGuanMixed.ReadyFightMission,0);
end
function wnd_tuiguanClass:EnterBattleFiled()

    local Next = sdata_MissionState:GetNext(TuiGuanMixed.CurrentAttackMission)
   
end

function wnd_tuiguanClass:OnInformationClick(gameObj,type)
	if type ==  ZhuCheng.PlayerInfo then
		
		wnd_playerinfo:Show() 
	elseif type ==  ZhuCheng.PaiHang then
		local jsonNM = QKJsonDoc.NewMap()	
		jsonNM:Add("n","RankList")  
		local loader = GameConn:CreateLoader(jsonNM,2) 
		HttpLoaderEX.WaitRecall(loader,self,self.NM_ReGetPaiHangBangList)
	elseif type ==  ZhuCheng.Mail then
		local jsonNM = QKJsonDoc.NewMap()	
		jsonNM:Add("n","MailList")  
		local loader = GameConn:CreateLoader(jsonNM,0) 
		HttpLoaderEX.WaitRecall(loader,self,self.NM_ReGetMailList)
	elseif type ==  ZhuCheng.ChouJiang then
        wnd_ChouJiang:Show()
        --WndJumpManage:Jump(WND.Tuiguan,WND.ChouJiang)
        --wnd_tuiguan:Hide()
	elseif type ==  ZhuCheng.ChongZhi then
		wnd_chongzhi:Show()
	elseif type ==  ZhuCheng.PaiKu then
        self.FirstShowPaikuPage = 1 --用于保存需要显示的页面
        wnd_CardHouse:Show()
        exui_CardCollection:Show()
		--WndJumpManage:Jump(WND.Tuiguan,WND.CardHouse)
	elseif type ==  ZhuCheng.Hero then
--		wnd_recruitHero:Show()
--		wnd_recruitHero:PlayerHeroData(1014)

    elseif type ==  ZhuCheng.BuyHero then
		self.bIsBuyhero = true
		self:GetServerTime()
--		wnd_recruitHero:PlayerHeroData(self.ser,self.IDhero)
--        wnd_recruitHero:Show()
	end
	--wnd_playerinfo:Show()
--		wnd_main:Hide()
--        wnd_tuiguan:Hide()
        
end
function wnd_tuiguanClass:NM_ReGetMailList(jsonDoc)
	wnd_Mail:FillData(jsonDoc)
	wnd_Mail:Show() 

--	wnd_paihangbang:FillData(jsonDoc)
--	wnd_paihangbang:Show()
end 



function wnd_tuiguanClass:NM_ReGetPaiHangBangList(jsonDoc)
	wnd_paihangbang:FillData(jsonDoc)
	wnd_paihangbang:Show()
end 

function wnd_tuiguanClass:UpdateStaticTxt()

    CodingEasyer:SetLabel(self.instance:FindWidget("ld/paizu_btn/txt"),SData_Id2String.Get(5002))
    CodingEasyer:SetLabel(self.instance:FindWidget("enlarge/txt"),SData_Id2String.Get(5060))
    CodingEasyer:SetLabel(self.instance:FindWidget("narrow/txt"),SData_Id2String.Get(5072))

end

function wnd_tuiguanClass:ShowCityInfo(id)
    --print("wnd_tuiguanClass:ShowCityInfo")

end

function wnd_tuiguanClass:UpdateResource()
	if wnd_tuiguan.isVisible == false then return end
	local Str = string.sformat(SData_Id2String.Get(5004),Player:GetNumberAttr(PlayerAttrNames.Copper))
	CodingEasyer:SetLabel(self.instance:FindWidget("coppper/txt"),Str)
	Str = string.sformat(SData_Id2String.Get(5004),Player:GetNumberAttr(PlayerAttrNames.Gold))
	CodingEasyer:SetLabel(self.instance:FindWidget("gold/txt"),Str)
	local viplv = Player:GetNumberAttr(PlayerAttrNames.CZLJCS)
	local JunLingMax = tostring( sdata_VIP:GetV(sdata_VIP.I_LingShangxian,viplv) )
	Str = string.sformat(SData_Id2String.Get(5005),self.JunLing,JunLingMax)
	CodingEasyer:SetLabel(self.instance:FindWidget("point/txt"),Str)
end

function wnd_tuiguanClass:OnShowDone()
   StartCoroutine(self, self.WaitLoadFinishToOnShowDone,{})
end

function wnd_tuiguanClass:WaitLoadFinishToOnShowDone()
    while TuiGuanMixed.isNeedCreate do
        Yield()
    end
 	print("wnd_tuiguanClass:OnShowDone")
    hadJumpedToTuiguan = true
	wnd_buzheng:NM_ReBuZhenInfo() 

	self:reHeroface()

	self:ExpBar()
    if not self.bIslistenmoney then
		OOSyncClient.BindValueChangedEvent(Player.sid,Player:GetPath(),PlayerAttrNames.Exp,self,self.ExpBar)
		OOSyncClient.BindValueChangedEvent(Player.sid,Player:GetPath(),PlayerAttrNames.Gold,self,self.changemoney)
		OOSyncClient.BindValueChangedEvent(Player.sid,Player:GetPath(),PlayerAttrNames.Copper,self,self.changemoney)
		OOSyncClient.BindValueChangedEvent(Player.sid,Player:GetPath(),PlayerAttrNames.Name,self,self.ExpBar)
		OOSyncClient.BindValueChangedEvent(Player.sid,Player:GetPath(),PlayerAttrNames.Level,self,self.showLevel)
        OOSyncClient.BindValueChangedEvent(Player.sid,Player:GetPath(),PlayerAttrNames.JunLing,self,self.JunLingListenr)
		self.bIslistenmoney = true
	end
	self:BindUIEvent ("gold/btn", UIEventType.Click, "OngoldClick")
	self:showbyhero()
    self:FillContent()
	self:changemoney()
    self:OnShiftCallBack()

    self:ForceOnCity()

     local sequencem = Sequence.new()
     sequencem:InsertCallback(1.0,self,self.AutoZPosition)

      WndManage.Hide("ui_prefight",0.5)
      self:ShowOrHidePaikuTips()

     print("wnd_tuiguanClass:OnShowDone End")
end

function wnd_tuiguanClass:showbyhero()
	self.IDhero = 0
	local gameObject = self:FindWidget("others/buyhero_btn")
	if #Player:GetHHeros()>0 then 
		gameObject:SetActive(true)
		meHerolist = Player:GetHHeros()[1]
		self.IDhero = meHerolist:GetNumberAttr(HInfo.DataID)
		self.bIsBuyhero = false
		self:GetServerTime()
		local MaHeroInfoList = SData_Hero.GetHero(self.IDhero) 
		local m_item = self.instance:FindWidget("hero_bg/img")
		local cmHead = m_item:GetComponent(CMUISprite.Name)
		MaHeroInfoList:SetHeroIcon(cmHead)

		self:BindUIEvent ("buyhero_btn", UIEventType.Click, "OnInformationClick",ZhuCheng.BuyHero)
		
	else
		gameObject:SetActive(false)
	end
end
function wnd_tuiguanClass:showLevel()
--	if wnd_tuiguan.isVisible == false then 
--		return 
--	end 
	--type==2代表升星
	wnd_success:showType(2) 
	wnd_success:Show() 
end
function wnd_tuiguanClass:OngoldClick()
	WndJumpManage:Jump(WND.Tuiguan,WND.Chongzhi)
end

function wnd_tuiguanClass:AttackFlagInScreen(_IsOut)
    if self.AttackInScreenOld == _IsOut then return end
    local obj = self.instance:FindWidget("enlarge/light")
    self.AttackInScreenOld = _IsOut
    local CTween = obj:GetComponent(CMUITweener.Name)

    if _IsOut then
        CTween:PlayForward()
    else
        CTween:PlayReverse()
    end   
end

function wnd_tuiguanClass:TimeUpdate(time_num,time_str)
    local Str = string.sformat(SData_Id2String.Get(5004),time_str)
    CodingEasyer:SetLabel(self.instance:FindWidget("time_bg/txt"),Str)
end
function wnd_tuiguanClass:SetCountDownEndFunc(time_num,time_str)
	local jsonNM = QKJsonDoc.NewMap()	
	jsonNM:Add("n","SFHH")  
    jsonNM:Add("hid",Player:GetHHeros()[1]:GetNumberAttr(HInfo.DataID)) 
	local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.ReleasrTrueClick)
end
function wnd_tuiguanClass:ReleasrTrueClick(jsonDoc)
	local num = tonumber(jsonDoc:GetValue("r"))
	if num == 0 then
		self:showbyhero()
	else
		local gameObject = self:FindWidget("others/buyhero_btn")
		gameObject:SetActive(false)		
	end
end
function wnd_tuiguanClass:BindTimeCount()
	self.TimeCountCm = self.gameobj:AddComponent("component/CMUICountDown")
	self.TimeCountCm:SetTextFillFunc(self,self.TimeUpdate)
	self.TimeCountCm:SetCountDownEndFunc(self,self.SetCountDownEndFunc) 
end
function wnd_tuiguanClass:reHeroface()
	local each_func = function(key,row)
		if row[sdata_NormalHead.I_ID] == Player:GetNumberAttr(PlayerAttrNames.FaceIndex) then
			local m_H = self.instance:FindWidget("TouxiangImg/head_panel/img_panel/img")
			local pHead = m_H:GetComponent(CMUISprite.Name)
			pHead:SetAtlas(row[sdata_NormalHead.I_PackageName], row[sdata_NormalHead.I_AtlasName])
			pHead:SetSpriteName(row[sdata_NormalHead.I_Skin])
		end
	end
	sdata_NormalHead:Foreach(each_func)    
end 
function wnd_tuiguanClass:changemoney()
	if wnd_tuiguan.isVisible == false then 
		return 
	end 
	CodingEasyer:SetLabel(self.instance:FindWidget("gold/txt"),Player:GetAttr(PlayerAttrNames.Gold))
	CodingEasyer:SetLabel(self.instance:FindWidget("coppper/txt"),Player:GetAttr(PlayerAttrNames.Copper))
end
--军令变更监听
function wnd_tuiguanClass:JunLingListenr()
	self:SyncJL()
    self:UpdateResource()
end 

--主公经验条
function wnd_tuiguanClass:ExpBar()
	if wnd_tuiguan.isVisible == false then 
		return 
	end 

    CodingEasyer:SetLabel(self.instance:FindWidget("TouxiangImg/txt_name"),Player:GetAttr(PlayerAttrNames.Name))
    local lv = Player:GetNumberAttr(PlayerAttrNames.Level)
    local Str = string.sformat(SData_Id2String.Get(5004),Player:GetNumberAttr(PlayerAttrNames.Level))
	CodingEasyer:SetLabel(self.instance:FindWidget("TouxiangImg/txt_lv"),Str)

    local exp = self.instance:FindWidget("head_panel/exp")
	local Exp = exp:GetComponent(CMUISprite.Name)
	local i = 0 
	local eatchfunch = function (key,value)
		i = i+1
	end
	sdata_KeyValueMath:Foreach(eatchfunch)
	if Player:GetNumberAttr(PlayerAttrNames.Level) < i then
		local e = sdata_KeyValueMath:GetV(sdata_KeyValueMath.I_EXP,lv+1)
		local E =  Player:GetNumberAttr(PlayerAttrNames.Exp)
		Exp:SetFillAmount(E/e)
	end

end 
--实例即将被丢失
function wnd_tuiguanClass:OnLostInstance()
    print("wnd_tuiguanClass:OnLostInstance")
	self:ClearAllCityUI()
    TuiGuanMixed.isLostInstance = true
    self.TuiGuanBaoXiang = nil;
end 


function wnd_tuiguanClass:ClearAllCityUI()
    local temp = 1
    for k,v in pairs (TuiGuanCitys) do 
        v:Destroy()
        temp = temp + 1
    end
    temp = 1
    TuiGuanCitysShadow = {}
    TuiGuanCitys = {}

    for k,v in pairs (TuiGuanProvinces) do 
        v:Destroy()
        temp = temp + 1
    end
    TuiGuanProvinces = {}
    for k,v in pairs (self.TuiGuanClouds) do 
        v:Destroy()
    end
    self.TuiGuanClouds = {};

    TuiGuanMixed.isNeedCreate = true
end 

function wnd_tuiguanClass:Debug()

    local temp = function( Doc )end
    
    print("Test:",temp,type( temp ))

end

function wnd_tuiguanClass:Wait(key)
    if key % 30 ==0 then
        Yield(0.5)
    end
end

function wnd_tuiguanClass:CreateAllCityUI()--加载城、省、云   
    if TuiGuanMixed.isNeedCreate == false then
        return 
    end
    self.m_CityItem:SetActive(true)
    self.m_ProvincesItem:SetActive(true)
    local i = 1
    local eatchfunch = function (key,value)
        local itemObj = GameObject.InstantiateFromPreobj(self.m_CityItem,self.m_CityItem:GetParent())
        local temp = Vector3.Zero        
        local x = tonumber(sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicX,key) )
        local y = tonumber(sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicY,key) )
        local Icon = sdata_MissionCity:GetV(sdata_MissionCity.I_CityIcon,key)

        itemObj:SetLocalPosition(Vector3.new(x,y,0))--位置出生位置
		itemObj:SetName("City_CreateCity"..key)
        TuiGuanCitys[key] = itemObj
        local Flag = itemObj:FindChild("occupied")
        Flag:SetActive(false)
        TuiGuanCitysShadow[i] = key
        self:SetLabel("City_CreateCity"..key.."/name_bg/txt",value[sdata_MissionCity.I_Name])
        self:BindUIEvent ("City_CreateCity"..key, UIEventType.Click, "OnClickCity",key)--点击的城
        self:Wait(key)
        i = i + 1 
	end
    print("City Load Finish")
	sdata_MissionCity:Foreach(eatchfunch)
    i = 1 
    local eatchfunch = function (key,value)
        local itemObj = GameObject.InstantiateFromPreobj(self.m_ProvincesItem,self.m_ProvincesItem:GetParent())
        local x = tonumber(sdata_MissionState:GetV(sdata_MissionState.I_MainCityPicX,key) )
        local y = tonumber(sdata_MissionState:GetV(sdata_MissionState.I_MainCityPicY,key) )
    
        itemObj:SetLocalPosition(Vector3.new(x,y,0))--位置出生位置
		itemObj:SetName("City_CreateProvinces"..key)
        local Name = itemObj:FindChild("shengbiao_btn/name_img/txt")
        CodingEasyer:SetLabel(Name,sdata_MissionState:GetV(sdata_MissionState.I_Name,key))
        TuiGuanProvinces[key] = itemObj
        self:BindUIEvent ("City_CreateProvinces"..key, UIEventType.Click, "OnClickProvinces",key)--点击的省
        self:Wait(key)
        i = i + 1 
	end
    print("Provinces Load Finish")
	sdata_MissionState:Foreach(eatchfunch)
    --开始创建云层
     i = 1 
    local eatchfunch = function (key,value)

        local itemObj = self.instance:FindWidget("mapfollowpanel/map_widget/cloud/cloud"..key)
        if(itemObj == nil)then
            return;
        end
        self.TuiGuanClouds[key] = itemObj
        self:Wait(key)
        i = i + 1 
	end
    print("Cloud Load Finish")
	sdata_MissionState:Foreach(eatchfunch)

    self.m_Treasure:SetActive(false)
    self.m_CityItem:SetActive(false)
    self.m_ProvincesItem:SetActive(false)
   -- self.m_CloudItem:SetActive(false)
    TuiGuanMixed.isNeedCreate = false
end
function wnd_tuiguanClass:SetCloudClick(id,enable)

    if(self.TuiGuanClouds ~= nil and self.TuiGuanClouds[id])then
        local quad = self.TuiGuanClouds[id]:GetComponent(QKUIQuad.Name);
        if(quad ~= nil)then
            --quad:SetColorID(key);
            --quad:SetWidgetSize(200,200);
            quad:SetColliderEnable(enable);
        end
    end
end

function wnd_tuiguanClass:nm_TreasureCallBack(jsonDoc)
    local Result = tonumber (jsonDoc:GetValue("r"))
    print("wnd_tuiguanClass:nm_TreasureCallBack Result",Result)
    if  Result ~= 0 then
         print("Result:",Result)
         return 
    end
    Poptip.PopMsg("领奖成功",Color.white)

	local TempJL = {}
	local JLList = jsonDoc:GetValue("jl")
	local rankFunc = function(_,JLNode)
		local JL = CodingEasyer:GetJL(JLNode)
		table.insert(TempJL,JL)
	end

	JLList:Foreach(rankFunc)

	wnd_itemget:JLtype(TuiGuanMixed.TreasureType)
	wnd_itemget:Fdata(TempJL,"wnd_tuiguan")

	if jsonDoc:GetValue("Secjl") ~= ""then
		local TempJLSec = {}
		local JLListSec = jsonDoc:GetValue("Secjl")
		local rankFunc = function(_,JLNode)
			local JL = CodingEasyer:GetJL(JLNode)
			table.insert(TempJLSec,JL)
		end
		JLListSec:Foreach(rankFunc)
		wnd_itemget:FdataSec(TempJLSec)
	end
	wnd_itemget:Show()

    self:SyncMissionTresure()
    self:UpdateTreasure()


end

function wnd_tuiguanClass:Check()
    local temp = Player:GetObjectF("ply/AHeroInfos")

    local Func = function( Doc )
        local v = Doc:GetValue("State")
        local i = Doc:GetValue("id")
        print("wnd_tuiguanClass:Check == ",i,v)
    end
    temp:Foreach(Func)
end 

function wnd_tuiguanClass:OnClickProvinceTreasure(gameObj,id)
    print("wnd_tuiguanClass:OnClickTreasureHard",id)
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GKSCC")  
	jsonNM:Add ("sid", id)
    
    print("领取产出："..id)
	local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.nm_ProvinceTreasureCallBack)   
end 
function wnd_tuiguanClass:nm_ProvinceTreasureCallBack(jsonDoc)
    
    local Result = tonumber (jsonDoc:GetValue("r"))
    print("wnd_tuiguanClass:nm_ProvinceTreasureCallBack Result",Result)
    if  Result ~= 0 then
         print("Result:",Result)
         return 
    end
    local TempJL = {}
    local JLList = jsonDoc:GetValue("jl")
    print("wnd_tuiguanClass:nm_ProvinceTreasureCallBack",JLList)
    local rankFunc = function(_,JLNode)
        table.insert(TempJL,CodingEasyer:GetJL(JLNode))
    end
    JLList:Foreach(rankFunc)
end

function wnd_tuiguanClass:OnClickTreasureHard(gameObj,id)
    print("wnd_tuiguanClass:OnClickTreasureHard",id)
    self:SendTreasureNetWork(id,TuiGuanEnum.Hard)
end 

function wnd_tuiguanClass:OnClickTreasureNormal(gameObj,id)
    print("wnd_tuiguanClass:OnClickTreasureNormal",id)
    self:SendTreasureNetWork(id,TuiGuanEnum.Normal)
end 
function wnd_tuiguanClass:SendTreasureNetWork(id,typeT)
    print("wnd_tuiguanClass:SendTreasureNetWork",id,typeT)
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GKB")  
	jsonNM:Add ("btype", typeT)
	jsonNM:Add ("cid", id)
    
    TuiGuanMixed.TreasureID = id
    TuiGuanMixed.TreasureType = typeT
    
    print("领取宝箱："..id,"类型：",typeT)
	local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.nm_TreasureCallBack)   
end
function wnd_tuiguanClass:isProvinceOpen(ProvinceID)
    local FirstMission = sdata_MissionState:GetFirstMission(ProvinceID)
    local LastMission = sdata_MissionState:GetLastMission(ProvinceID)
  
    if TuiGuanMixed.CurrentWinMission > LastMission then 
        return 1 --占领过这个省
    end   
    
    if TuiGuanMixed.CurrentWinMission == LastMission then 
        return 2 --刚好开启下个省
    end       
    
    if TuiGuanMixed.CurrentWinMission >= FirstMission and TuiGuanMixed.CurrentWinMission < LastMission then 
        return 3 --这个省处于战斗状态 但是没完全打完
    end  
    --TuiGuanMixed.CurrentWinMission<FirstMission
    return 4 --不能点
end
--判断当前省是否是正好开启状态
function wnd_tuiguanClass:isProOpen(ProvinceID)
    if(ProvinceID > 1)then
       local proID = sdata_MissionState:GetPreState(ProvinceID)
       return self:isProvinceOpen(proID)
    end
    return 1
end
function wnd_tuiguanClass:OnClickProvinces(gameObj,id)
	if id > Player:GetNumberAttr(PlayerAttrNames.diaJD) then
		local jsonNM = QKJsonDoc.NewMap()	
		jsonNM:Add ("n","Spolt")  
		jsonNM:Add ("diaJD",id)  
		local loader = GameConn:CreateLoader(jsonNM,0)
		HttpLoaderEX.WaitRecall(loader,self,self.NM_SetjuqingCallBack)
	end		

    self:ForceOnProvinceID(id)
	self.m_ZoomScale:OnShift()
end 
function wnd_tuiguanClass:NM_SetjuqingCallBack(jsonDoc)
	wnd_Storybooks:FillData(jsonDoc)
	wnd_Storybooks:Show()
end
function wnd_tuiguanClass:OnGiveUpCity()
    local name = sdata_MissionMonster:GetV(sdata_MissionMonster.I_Name,TuiGuanMixed.CurrentAttackMission)
    local temp = string.sformat(SData_Id2String.Get(5318),name)
    MsgBox.SetTitle(SData_Id2String.Get(5350))
    MsgBox.Show(temp,"否","是",self,self.MessageBoxCallBack)
    
end 

function wnd_tuiguanClass:MessageBoxCallBack(id)
  print("MessageBoxCallBack",id) --id：2 True  --id：1 False
    if id == 2 then
        self:SendGiveUpNetWork(TuiGuanGiveUpType.TuiGuan)
    end     
end


function wnd_tuiguanClass:OnClickCity(gameObj,id)
    print("wnd_tuiguanClass:OnClickCity",gameObj,id,TuiGuanMixed.CurrentAttackMission,TuiGuanMixed.CurrentWinMission)

    local NextMission = sdata_MissionMonster:GetNext(TuiGuanMixed.CurrentWinMission)
    local Cityn,Provincen = sdata_MissionMonster:GetOrganization(NextMission)

    if id > Cityn then --点的关比当前可打的关靠后
        Poptip.PopMsg("上一关还没通关",Color.red)
        return
    end

    if TuiGuanMixed.CurrentAttackMission ~= 0 then --当前正在攻打某城
        local City,Province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentAttackMission)
        if City ~= id then --点的不是正在打的城
            self:OnGiveUpCity()
            return 
        end
    end

    wnd_readyfight:SetCity(ReadyFightType.Normal ,id)
    wnd_readyfight:Show()
end 

function wnd_tuiguanClass:C_GKGiveupBreak_Local()
    
    TuiGuanMixed.CurrentAttackMission = 0
    TuiGuanMixed.ReadyFightMission = 0

end

function wnd_tuiguanClass:C_GKFGiveupBreak_Sync()
    print("wnd_tuiguanClass:C_GKFGiveupBreak_Sync  ==============  ",TuiGuanMixed.CurrentAttackMission,TuiGuanMixed.CurrentWinMission)
    Player:SetSyncMission(TuiGuanMixed.CurrentAttackMission,TuiGuanMixed.CurrentWinMission)
    Player:Delete(PlayerSyncBase.."/"..PlayerTags.gkTargets)
    self:AllStateAHeroState(2)
    local Node = Player:GetObjectF(PlayerSyncBase.."/"..PlayerTags.Frms.."/1")
    Node:SetValue(FrmsNames.ZhenPos,"")

end

function wnd_tuiguanClass:SendGiveUpNetWork(_type)
       
    if TuiGuanMixed.CurrentAttackMission == 0 then
        Poptip.PopMsg(SData_Id2String.Get( 5338 ),Color.red)
        return
    end

    self:C_GKGiveupBreak_Local()
    self:C_GKFGiveupBreak_Sync()

    TuiGuanMixed.GiveUpType = _type
    
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GKFQ")  
    jsonNM:Add ("t",TuiGuanEnum.Normal) 
    --local loader = GameConn:CreateLoader(jsonNM,0) 
    --HttpLoaderEX.WaitRecall(loader,self,self.nm_GiveUpCallBack)

    YQ2GameConn:SendRequest(jsonNM,0,true,self,self.nm_GiveUpCallBack) 
end
function wnd_tuiguanClass:nm_GiveUpCallBack(_Result)
    if _Result:IsFirstFinished() ~= true then return end
    local jsonDoc = CodingEasyer:GetResult(_Result)

    if jsonDoc~= nil then 
        local Result = tonumber (jsonDoc:GetValue("r"))
        if  Result ~= 0 then
             print("r:10,当前没有正在攻打的城")
             print("Result:",Result)
             return 
        end
    end
    wnd_readyfight:SetMission(0)
    self:RandomCardLimit(false)
    self:AllStateAHeroState(2)
    self:AllAHeroHP(-1)
    self:SyncMission()

    if TuiGuanMixed.GiveUpType == TuiGuanGiveUpType.FightWin then
        wnd_fightwin:AfterGiveUp()
    else
        self:UpdateCurrentAttackFlag()

        self:UpdateNextCityFlag()
    end

    exui_CardCollection:GiveUpAtTuiguan()
end

function wnd_tuiguanClass:SyncMission()
    
    local gkInfo = Player:GetGKInfo()
    local gkCur = Player:GetObjectF("ply/gkSaveFiles/0")
    local gkWin = Player:GetObjectF("ply/gkSaveFiles/1")

    if gkCur ~= nil then 
        TuiGuanMixed.CurrentAttackMission = tonumber( gkCur:GetValue(GKSaveFileAttrNames.MissionID) )
    end

    if gkWin ~= nil then 
        TuiGuanMixed.CurrentWinMission = tonumber( gkWin:GetValue(GKSaveFileAttrNames.MissionID) )
        print("wnd_tuiguanClass:SyncMission ==== Win:",TuiGuanMixed.CurrentWinMission)
    end

    TuiGuanMixed.OpenProvince = Player:GetOpenProvinceID()
    
end

function wnd_tuiguanClass:SyncMissionTresure()
    local gkInfo = Player:GetGKInfo()
    local i = 1
    TuiGuanTreasure = {}
    TuiGuanProvinceTreasure = {}

    local eatchfunch = function (key,value)
        TuiGuanProvinceTreasure[key] = false
	end
	sdata_MissionState:Foreach(eatchfunch)

    local eachFuncBox = function (syncObj)
        local Treasure = {}
        Treasure.City = tonumber( syncObj:GetValue(GKCityBoxsAttrNames.City) )

        local Province = sdata_MissionCity:GetV(sdata_MissionCity.I_StateID,Treasure.City)

        Treasure.NormalState = tonumber( syncObj:GetValue(GKCityBoxsAttrNames.NormalState) )
        Treasure.HardState = tonumber( syncObj:GetValue(GKCityBoxsAttrNames.HardState) )
        --print("wnd_tuiguanClass:SyncMissionTresure City:",Treasure.City,"Normal：",Treasure.NormalState,"Hard：",Treasure.HardState)
        TuiGuanTreasure[Treasure.City] = Treasure

        if Treasure.NormalState == 1 or Treasure.HardState == 1 then
            TuiGuanProvinceTreasure[Province] = true
        end

        i = i + 1
    end
    gkInfo:ForeachCityBoxs(eachFuncBox)

    local count = sdata_MissionCity:GetCount()
    for j = i,count do
        local Treasure = {}
        Treasure.City = j
        Treasure.NormalState = 0
        Treasure.HardState = 0
        TuiGuanTreasure[j] = Treasure
    end
end

function wnd_tuiguanClass:GetNextMissionByCurrWin()
    TuiGuanMixed.NextMission = sdata_MissionMonster:GetNext(TuiGuanMixed.CurrentWinMission)
end

function wnd_tuiguanClass:TuiGuanDetail()
    self:SyncMission()
    self:SyncMissionTresure()
    self:GetNextMissionByCurrWin()
    self:SyncJL()
    self:UpdateResource()

end

function wnd_tuiguanClass:ReadyFightMission(ID)
    TuiGuanMixed.ReadyFightMission = ID
    QY2LessonManager.SetGuanQiaID(TuiGuanMixed.ReadyFightMission,0);
end

function wnd_tuiguanClass:RandomCardLimit(_Random)
    --已经随机过了，还要随机
    print("wnd_tuiguanClass:RandomCardLimit",TuiGuanMixed.isAlreadyRandomCard,_Random)
    if TuiGuanMixed.isAlreadyRandomCard and _Random then
        return false
    end

    TuiGuanMixed.isAlreadyRandomCard = _Random

    return true
end
 
function wnd_tuiguanClass:MoveNextTargetWhenSyncNIL()

    local tar = Player:GetObjectF("ply/gkTargets/0")
    if tar == nil then 
        Player:GetObject("ply/gkTargets/0")
        self:FakeMissionTarget(TuiGuanMixed.ReadyFightMission)
    end

end

function wnd_tuiguanClass:SendEnterGKNetWork()
    
    local city , province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.ReadyFightMission)
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GKIN")  
	jsonNM:Add ("t", TuiGuanEnum.Normal)
	jsonNM:Add ("s", province)
	jsonNM:Add ("c", city)  
    jsonNM:Add ("g", TuiGuanMixed.ReadyFightMission)

    self:MoveNextTargetWhenSyncNIL()
    self:C_GKINBreak_Local(TuiGuanMixed.ReadyFightMission)
    if self:RandomCardLimit(true) then
        self:SetJustWin(false)
        self:C_GKINBreak_Sync(TuiGuanMixed.ReadyFightMission)
        jsonNM:Add ("cL", self.AHeroChangeList)
        local Func = function(k,v)
            print(k,v)
        end
        self.AHeroChangeList:Foreach(Func)
        self.AHeroChangeList = {}
    end

    print("wnd_tuiguanClass:SendEnterGKNetWork.....lwy")
    YQ2GameConn:SendRequest(jsonNM,0,true,self,self.nm_EnterGKCallBack)
    print("wnd_tuiguanClass:SendEnterGKNetWork.....lwy do")

end

function wnd_tuiguanClass:isHaveAHero()
    local temp = Player:GetObjectF("ply/AHeroInfos")
    if temp == nil then return false end
    local v = false
    local Func = function( Doc )
        v = true
    end
    temp:Foreach(Func)

    return v
end

function wnd_tuiguanClass:nm_EnterGKCallBack(_Result)
    print("wnd_tuiguanClass:nm_EnterGKCallBack0")
    if _Result:IsFirstFinished() ~= true then 
        --WndJumpManage:Jump(WND.Readyfight,WND.BuZheng) 
        return 
    end
    print("wnd_tuiguanClass:nm_EnterGKCallBack1")
    local jsonDoc = CodingEasyer:GetResult(_Result)
    if jsonDoc == nil then 
        self:TuiGuanDetail()
        self:UpdateCurrentAttackFlag()
        self:UpdateNextCityFlag()
        WndJumpManage:Jump(WND.Readyfight,WND.BuZheng)
        return
    end

    print("wnd_tuiguanClass:nm_EnterGKCallBack2")
    local Result = tonumber (jsonDoc:GetValue("r"))
    if  Result ~= 0 then
         print("r:<处理结果 int>#0-成功 10-选择了其他城市 11-不可攻打已通关 12-验证下一关有误 20-武将已经全部死亡")
         print("Result:",Result)
         if tonumber( Result ) == 30 then 
            Poptip.PopMsg(SData_Id2String.Get( 5312 ),Color.red )
         end
         return 
    end
    print("wnd_tuiguanClass:nm_EnterGKCallBack3")
    self:TuiGuanDetail()
    self:UpdateCurrentAttackFlag()
    self:UpdateNextCityFlag()

    WndJumpManage:Jump(WND.Readyfight,WND.BuZheng)
end
function wnd_tuiguanClass:SendPerformanceNetWork()
    print("wnd_tuiguanClass:SendPerformanceNetWork")
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GKFake")  
    local loader = GameConn:CreateLoader(jsonNM,0)
    HttpLoaderEX.WaitRecall(loader,self,self.nm_PerformanceCallBack)
    print("wnd_tuiguanClass:SendPerformanceNetWork End")
end

function wnd_tuiguanClass:nm_PerformanceCallBack(jsonDoc)
    print("wnd_tuiguanClass:nm_PerformanceCallBack")
    self.isPerformance = 1
    Battlefield.Reset()
    wnd_tuiguan:Show()
    print("wnd_tuiguanClass:nm_PerformanceCallBack End")
end

function wnd_tuiguanClass:SendEndGKNetWork()
    
    
    local city , province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.ReadyFightMission)
    local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","GKFend")  
    jsonNM:Add ("g", TuiGuanMixed.ReadyFightMission)
    jsonNM:Add ("iw",TuiGuanMixed.isWin)
    local BattleTime = wnd_fightwin:GetBattleTime()
    jsonNM:Add ("pt",BattleTime)

    self.ResultHeros = QKJsonDoc.NewMap()	
    wnd_fightwin:AddHeros(self.ResultHeros)
    jsonNM:Add ("finfo",self.ResultHeros)
    
    self:SetJustWin(true)
    
    self:C_GKFEndBreak_Local()
    self:C_GKFEndBreak_Sync()
    self:ClearBZ_IFCityWin()
    
    

    if TuiGuanMixed.isWin == 1 then
        if sdata_MissionMonster:isLastMissionInCity(TuiGuanMixed.ReadyFightMission) == false then
            self:C_GKINBreak_Sync_GKFend(TuiGuanMixed.CurrentAttackMission)
            jsonNM:Add ("cL",self.AHeroChangeList)
            self:RandomCardLimit(true)
        else 
            self:RandomCardLimit(false)
        end
    else

    end
    ---- 发送请求 
	YQ2GameConn:SendRequest(jsonNM,0,true,self,self.nm_EndGKCallBack) 
end
function wnd_tuiguanClass:TipIFRecuritHero(jsonDoc)
    print("wnd_tuiguanClass:TipIFRecuritHero:",jsonDoc)
    if jsonDoc == nil then return end
    TuiGuanMixed.RecuritID = tonumber (jsonDoc:GetValue("dlhero"))
    if TuiGuanMixed.RecuritID ~= nil then 
        if TuiGuanMixed.RecuritID ~= 0 then 
            local Temp = SData_Hero.GetHero(TuiGuanMixed.RecuritID)
            Poptip.PopMsg("恭喜玩家可招募新武将："..Temp:Name(),Color.white)
        end
    end
end

function wnd_tuiguanClass:JumpIFLose()
    local City = sdata_MissionMonster:GetV(sdata_MissionMonster.I_CityID,TuiGuanMixed.ReadyFightMission)
    local NextMission = sdata_MissionMonster:GetV(sdata_MissionMonster.I_NextMonster,TuiGuanMixed.ReadyFightMission)
    
    if NextMission ~= 0 then
        local City2 = sdata_MissionMonster:GetV(sdata_MissionMonster.I_CityID,NextMission)
        if (TuiGuanMixed.isWin == 1 and City ~= City2) then 

        else
            WndJumpManage:PushWindow(WND.Readyfight,WND.Fightwin)
        end 
    end
end

function wnd_tuiguanClass:GetJLBeforeFightEnd(jsonDoc)
    local TempJL = {}
    local JLList = jsonDoc:GetValue("jl")
    if JLList ~= nil then
        local rankFunc = function(_,JLNode)
            local JL = CodingEasyer:GetJL(JLNode)
            table.insert(TempJL,JL)
        end
        JLList:Foreach(rankFunc)
    end
end

function wnd_tuiguanClass:RecuritIFWNDLost()
    if wnd_tuiguan.isVisible == true then
        self:showbyhero()
    end
end
function wnd_tuiguanClass:C_GKFEndBreak_Local()
    --赢了
    if TuiGuanMixed.isWin == 1 then 

        if TuiGuanMixed.CurrentAttackMission > TuiGuanMixed.CurrentWinMission then 
            TuiGuanMixed.CurrentWinMission = TuiGuanMixed.CurrentAttackMission
            print("wnd_tuiguanClass:C_GKFEndBreak_Local =========== Win：",TuiGuanMixed.CurrentAttackMission)
        end
        --恰好通关城
        if sdata_MissionMonster:isLastMissionInCity( TuiGuanMixed.ReadyFightMission ) then 
            TuiGuanMixed.CurrentAttackMission = 0
            wnd_readyfight:SetMission(0)
        --不是正好通关城
        else
            TuiGuanMixed.CurrentAttackMission = TuiGuanMixed.ReadyFightMission
        end 
        --更新 TuiGuanMixed.NextMission 
        self:GetNextMissionByCurrWin()
    else 
    --输了
    end
end

function wnd_tuiguanClass:GetAHeroTableIFState( _State )
    --生成参数状态集合
    local Random = {}

    local temp = Player:GetObjectF("ply/AHeroInfos")
    local Func = function( Doc )
        local State = tonumber( Doc:GetValue("State") )
        local ID = tonumber( Doc:GetValue("id") )
        if State == tonumber( _State ) then
            table.insert(Random,ID)
        end
        --print( "ID: " ,ID,"State: ",State )
    end
    temp:Foreach( Func )
    return Random
end

function wnd_tuiguanClass:AllStateAHeroState( _State1 )
    local temp = Player:GetObjectF("ply/AHeroInfos")
    local Func = function( Doc )
        local ID = Doc:GetValue("id")
        local Sta = Doc:GetValue("State")
        
        Doc:SetValue(AHeroinfos.State, tostring( _State1) )
        local Resu = Doc:GetValue("State")
    end
    temp:Foreach( Func )
end
function wnd_tuiguanClass:AllAHeroHP( _HP )
    local temp = Player:GetObjectF("ply/AHeroInfos")
    local Func = function( Doc )
        Doc:SetValue(AHeroinfos.hp, tostring( _HP) )
    end
    temp:Foreach( Func )
end
function wnd_tuiguanClass:AllAHeroState( _State1 , _State2)
    local temp = Player:GetObjectF("ply/AHeroInfos")
    local Func = function( Doc )
        local State = tonumber( Doc:GetValue("State") )
        local ID = tonumber( Doc:GetValue("id") )
        if State == tonumber( _State1 ) then
            self:MergeAHeroState(ID,_State2)
        end
    end
    temp:Foreach( Func )
end

function wnd_tuiguanClass:ChangeAHeroState(_ID,_State)
    if _ID == nil then return end
    local Temp = Player:GetObjectF("ply/AHeroInfos/".._ID)
    Temp:SetValue(AHeroinfos.State, tostring( _State) )
end

function wnd_tuiguanClass:MergeAHeroState(_ID,_State)
    if _ID == nil then return end

    self:ChangeAHeroState(_ID,_State)

    local Doc = QKJsonDoc.NewMap()
    self.AHeroChangeList:Add(_ID,_State)

end

function wnd_tuiguanClass:IsPerfectPass(_City)
    local Treasure = TuiGuanTreasure[_City]
    if Treasure == nil then return false end
    if Treasure.HardState == nil then return false end
    local Result = tonumber( Treasure.HardState ) ~= 0 
    --print("wnd_tuiguanClass:IsPerfectPass:",Result)
    return Result
end
function wnd_tuiguanClass:RandomOnce(_Random)
    --随机出表中某元素
    local nIndex = math.ceil( math.random( 0,#_Random ) )
    if _Random == nil then return nil end
    if #_Random == 0 then return nil end
    return _Random[nIndex+1]
end
function wnd_tuiguanClass:GetEnemyArmy(_HID)
    local gkInfo = Player:GetObjectF("ply/gkTargets/0")
    local TempValue = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterArmyNo,TuiGuanMixed.ReadyFightMission)
    if gkInfo == nil then 
        return TempValue
    end

    local JsonDoc = QKJsonDoc.NewArray()   
    local zfInfo = gkInfo:GetValue(GKTarget.zfPos)
    JsonDoc:Parse(zfInfo)
    local eachFuncInfo = function (_,Info)
        if _HID == tonumber( Info:GetValue("eid") ) then
            TempValue = Info:GetValue("aNum")
        end
    end
    JsonDoc:Foreach(eachFuncInfo)
    return TempValue
end
function wnd_tuiguanClass:GetEnemyHP(_HID)

    local gkInfo = Player:GetObjectF("ply/gkTargets/0")
    local TempValue = -1
    if gkInfo == nil then 
        return TempValue
    end
    local JsonDoc = QKJsonDoc.NewArray()   
    local zfInfo = gkInfo:GetValue(GKTarget.zfPos)
    JsonDoc:Parse(zfInfo)
    local eachFuncInfo = function (_,Info)
        if _HID == tonumber( Info:GetValue("eid") ) then
            TempValue = tonumber( Info:GetValue("ehp") )
            --print("wnd_tuiguanClass:GetEnemyHP ==== ",_HID,TempValue)
        end
    end
    JsonDoc:Foreach(eachFuncInfo)
    return TempValue
end

function wnd_tuiguanClass:TESTCODE()

    local Random = self:GetAHeroTableIFState(2)
    local ID = self:RandomOnce(Random)
end
function wnd_tuiguanClass:C_GKINBreak_Local( _Mission )
    TuiGuanMixed.CurrentAttackMission = _Mission
end

function wnd_tuiguanClass:C_GKINBreak_Sync_GKFend( _Mission )

    self.AHeroChangeList = QKJsonDoc.NewArray()

    if wnd_fightwin:IsAllDeaths() then return end

    local Next = sdata_MissionMonster:GetNext(_Mission)
    local IsNextLast = sdata_MissionMonster:isLastMissionInCity(Next)
    if IsNextLast then
        self:AllAHeroState(2,3)
        self:AllAHeroState(4,3)
    else
        local Random = self:GetAHeroTableIFState(4)
        local ID = self:RandomOnce(Random)
        self:MergeAHeroState(ID,3)

        local Random = self:GetAHeroTableIFState(2)
        local ID = self:RandomOnce(Random)
        self:MergeAHeroState(ID,4)
    end
        
end

function wnd_tuiguanClass:C_GKINBreak_Sync( _Mission )
    
    local isFirst = sdata_MissionMonster:isFirstMissionInCity(_Mission)
    local isLast = sdata_MissionMonster:isLastMissionInCity(_Mission)
    self.AHeroChangeList = QKJsonDoc.NewArray()
    if isFirst then --第一关发3备1
        
        for i = 1 ,3 do 
            local Random = self:GetAHeroTableIFState(2)
            local ID = self:RandomOnce(Random)
            self:MergeAHeroState(ID,3)
        end
		
        local Random = self:GetAHeroTableIFState(2)
        local ID = self:RandomOnce(Random)
        self:MergeAHeroState(ID,4)
   
    else    --发1备1
        local Random = self:GetAHeroTableIFState(4)
        local ID = self:RandomOnce(Random)
        self:MergeAHeroState(ID,3)

        local Random = self:GetAHeroTableIFState(2)
        local ID = self:RandomOnce(Random)
        self:MergeAHeroState(ID,4)
    end

    if isLast then --最后一关全发
        self:AllAHeroState(2,3)
        self:AllAHeroState(4,3)
    end

    Player:SetSyncMission(TuiGuanMixed.CurrentAttackMission,TuiGuanMixed.CurrentWinMission)
end

function wnd_tuiguanClass:C_GKFEndBreak_Sync()
    
    Player:SetSyncMission(TuiGuanMixed.CurrentAttackMission,TuiGuanMixed.CurrentWinMission)
    local zfPos = QKJsonDoc.NewArray()
    local Left = self.FightResult:LeftHeros()
    for k,v in pairs(Left) do 
        local ID = v:StaticDataID()
        local Hp = v:CurrHP()
        local FID = v:Fid()
        local temp = Player:GetObjectF("ply/AHeroInfos/"..ID)
        temp:SetValue(AHeroinfos.hp,tostring( Hp ))
        local State = 5
        if Hp == 0 then State = 1 end
        temp:SetValue(AHeroinfos.State,tostring( State ))

        if Hp > 0 then
            zfPos:Add(FID,ID)
        end
    end
    local zf = wnd_buzheng:GetZF()
    local Str = zfPos:ToString()
    local temp = Player:GetObjectF(PlayerSyncBase.."/"..PlayerTags.Frms.."/1")
    if temp ~= nil then 
		temp:SetValue(FrmsNames.ZhenID,tostring( zf ))
        temp:SetValue(FrmsNames.ZhenPos,Str)
    end

    if TuiGuanMixed.isWin == 0 then --输了 
        local zfPos2 = QKJsonDoc.NewArray()
        local Right = self.FightResult:RightHeros()
        for k,v in pairs(Right) do 
            local ID = v:StaticDataID()
            local Hp = v:CurrHP()
            local FID = v:Fid()
            local Army = v:AliveSoldiers()

            local m1 = QKJsonDoc.NewMap()
            m1:Add ("eid",tostring( ID ))  
            m1:Add ("ehp",tostring( Hp )) 
            m1:Add ("aNum",tostring( Army ))  

            zfPos2:Add(tostring(FID ),m1)
        end

        local Tar = Player:GetObjectF("ply/gkTargets/0")
        Tar:SetValue("zfPos",zfPos2:ToString())
    else --赢了
        Player:Delete("ply/gkTargets/0")

        local isLast = sdata_MissionMonster:isLastMissionInCity(TuiGuanMixed.CurrentAttackMission)
        local Next = sdata_MissionMonster:GetNext(TuiGuanMixed.CurrentAttackMission)
        if not isLast then 
            self:FakeMissionTarget(Next)
        end
    end
end

function wnd_tuiguanClass:FakeMissionTarget(_Mission)

    local Army = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterArmyNo,_Mission)
    local zf = sdata_MissionMonster:GetV(sdata_MissionMonster.I_ZhenfaID,_Mission)

    local zfPos = QKJsonDoc.NewArray()
    for i = 1 ,5 do 
        local ID = sdata_MissionMonster:GetHero(i,_Mission)
        local Hp = -1
        local FID = i

        local m1 = QKJsonDoc.NewMap()
        m1:Add ("eid",tostring( ID ))  
        m1:Add ("ehp",tostring( Hp )) 
        m1:Add ("aNum",tostring( Army ))  

        zfPos:Add(tostring(FID ),m1)
    end

    local Tar = Player:GetObject("ply/gkTargets/0")
    Tar:SetValue("zfPos",zfPos:ToString())
    Tar:SetValue("zfid",tostring( zf ))
    Tar:SetValue("sft","0")

end

function wnd_tuiguanClass:IsWinCity()

    local isLast = sdata_MissionMonster:isLastMissionInCity(TuiGuanMixed.CurrentAttackMission)
    if isLast and TuiGuanMixed.isWin == 1 then 
        return true
    end

    return false

end
    
function wnd_tuiguanClass:ClearBZ_IFCityWin()
    if self:IsWinCity() then
        self:AllStateAHeroState(2)
        local Node = Player:GetObjectF(PlayerSyncBase.."/"..PlayerTags.Frms.."/1")
        --Node:SetValue(FrmsNames.ZhenID,"0")
        Node:SetValue(FrmsNames.ZhenPos,"")
        --Player:Delete(PlayerSyncBase.."/"..PlayerTags.Frms)
        --Player:Delete("ply/Frms")

    end
end

function wnd_tuiguanClass:C_GKFEndBreak_UI(_Request)
    
    local jsonDoc = CodingEasyer:GetResult(_Request)
    self:RecuritIFWNDLost()
    self:TipIFRecuritHero(jsonDoc)	
    self:JumpIFLose()

    wnd_fightwin:SetReblood(true)
    wnd_fightwin:SetWinState(TuiGuanMixed.isWin)
    wnd_fightwin:SetJLList(jsonDoc)
    wnd_fightwin:Show()
    if jsonDoc ~= nil and tonumber (jsonDoc:GetValue("sjt")) ~= 0 then
	    self.sjt = tonumber (jsonDoc:GetValue("sjt"))
	    self.sjinfo = tonumber (jsonDoc:GetValue("sjinfo"))
		self.sjid = tonumber (jsonDoc:GetValue("sjid"))
    end
end
function wnd_tuiguanClass:nm_EndGKCallBack(_Result)
    if _Result:IsFirstFinished() ~= true then return end
    self:C_GKFEndBreak_UI(_Result)
end

function wnd_tuiguanClass:Routine()
    print("wnd_tuiguanClass:Routine")
    
    self:UpdateCurrentAttackFlag()

    self:UpdateProvince()

    self:UpdateCity()

    self:UpdateNextCityFlag()
    
    self:UpdateOccupied()
    
    self:UpdateTreasure()

    self:UpdateCloud();

    
end
function wnd_tuiguanClass:UpdateProvince()
    print("wnd_tuiguanClass:UpdateProvince")
    for k,v in pairs(TuiGuanProvinces) do 
        v:SetActive( k <= TuiGuanMixed.OpenProvince )
    end
    
end
function wnd_tuiguanClass:UpdateCity()

    local LastCity =  sdata_MissionState:GetLastCity(TuiGuanMixed.OpenProvince)
    local WinCity,WinPro = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentWinMission)
    local Next = sdata_MissionMonster:GetNext(TuiGuanMixed.CurrentWinMission)
    local NWinCity,NWinPro = sdata_MissionMonster:GetOrganization(Next)
    for k,v in pairs(TuiGuanCitys) do 
        v:SetActive( k <= LastCity )

        local widget = v:GetComponent(CMUIWidget.Name)
        local CityName = v:FindChild("name_bg")
        if k <= NWinCity then
            --亮
            widget:SetAlpha(1)
            CityName:SetActive(true)
        else
            --灭
            widget:SetAlpha(0.5)
            CityName:SetActive(false)
        end
    end

end

function wnd_tuiguanClass:UpdateNextCityFlag()
    
    local State = 1
    print("wnd_tuiguanClass:UpdateNextCityFlag")
    if TuiGuanMixed.CurrentAttackMission == 0 then 
        self.m_FlagCity = sdata_MissionMonster:GetNext(TuiGuanMixed.CurrentWinMission)
        local City,Province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentWinMission)
        State = Province
    else
        self.m_FlagCity = TuiGuanMixed.CurrentAttackMission
        local City,Province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentAttackMission)
        State = Province
    end

    if self.m_FlagCity == 0 then self.m_NextCity:SetActive(false) return end
    self:PositionObjToMission(self.m_NextCity,self.m_FlagCity)

    if State == 0 then self.m_CurrAttackProvince:SetActive(false) return end
    self.m_CurrAttackProvince:SetActive(false)
    local CNp = TuiGuanProvinces[State]:GetLocalPosition()
    self.m_CurrAttackProvince:SetLocalPosition(CNp)
end

function wnd_tuiguanClass:PositionObjToMission(obj,MissionID)--刷新当前攻打标记位置
    print("wnd_tuiguanClass:PositionObjToMission ====== ",MissionID)
    if MissionID <= 0 then 
        obj:SetActive(false)
        return
    end

    local CACityID,CAProvinceID  = sdata_MissionMonster:GetOrganization(MissionID)
    local CityTemp = TuiGuanCitys[CACityID]
    local x = tonumber(sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicX,CACityID) )
    local y = tonumber(sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicY,CACityID) )

    obj:SetLocalPosition(Vector3.new(x,y,0))
    obj:SetActive(true)

end
function wnd_tuiguanClass:UpdateCurrentAttackFlag()--刷新当前攻打标记位置

    local CACityID,CAProvinceID  = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentAttackMission)
    if CACityID <= 0 then self.m_CurrAttackCity:SetActive(false) return end

    local CityTemp = TuiGuanCitys[CACityID]
    local x = tonumber(sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicX,CACityID) )
    local y = tonumber(sdata_MissionCity:GetV(sdata_MissionCity.I_CityPicY,CACityID) )

    self.m_CurrAttackCity:SetLocalPosition(Vector3.new(x,y,0))
    self.m_CurrAttackCity:SetActive(true)
end


function wnd_tuiguanClass:UpdateOccupied()--刷新城市
    print("wnd_tuiguanClass:UpdateOccupied")
 
    local City,Province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.CurrentWinMission)
    for i = 1 ,#TuiGuanCitysShadow do
        local key = TuiGuanCitysShadow[i]
        local temp = TuiGuanCitys[key]
        local Flag =  temp:FindChild("occupied")
        Flag:SetActive(key <= City )
    end    
    City,Province = sdata_MissionMonster:GetOrganization(TuiGuanMixed.NextMission)
    local eatchfunch = function (key,value)
        local temp = TuiGuanProvinces[key]
        local Flag = temp:FindChild("occupied")
        Flag:SetActive(key < Province)
	end
	sdata_MissionState:Foreach(eatchfunch)
end

function wnd_tuiguanClass:UpdateTreasure()--刷新宝箱
    print("wnd_tuiguanClass:UpdateTreasure")
    for k,v in pairs(TuiGuanProvinces) do
        local Image = v:FindChild("shengbiao_btn/baoxiang_img")
        local Visible = TuiGuanProvinceTreasure[k]
        Image:SetActive(Visible)
    end
    if(self.TuiGuanBaoXiang == nil)then
        self.TuiGuanBaoXiang = {};
    end

    for i = 1,#TuiGuanCitys do
        if(self.TuiGuanBaoXiang[i] == nil)then
            self.TuiGuanBaoXiang[i]  = {}
            self.TuiGuanBaoXiang[i].GKNormal = self.instance:FindWidget("City_CreateCity"..i.."/occupied/normal")
            self.TuiGuanBaoXiang[i].GKPerfect = self.instance:FindWidget("City_CreateCity"..i.."/occupied/perfect")
        end
    
        self.TuiGuanBaoXiang[i].GKNormal:SetActive(TuiGuanTreasure[i].NormalState ~= 1)
        self.TuiGuanBaoXiang[i].GKPerfect:SetActive(TuiGuanTreasure[i].HardState ~= 1)
    end

    for i = #TuiGuanCitys,#self.TuiGuanBaoXiang do
        self.TuiGuanBaoXiang[i] = nil;
    end

    for i = 1,#TuiGuanCitys do

        local NeedNormal = TuiGuanTreasure[i].NormalState == 1
        local NeedHard = TuiGuanTreasure[i].HardState == 1
        
        local rewards = self.instance:FindWidget("City_CreateCity"..i.."/rewards")
        if rewards == nil then 
            rewards = GameObject.InstantiateFromPreobj(self.m_Rewards,TuiGuanCitys[i])
            rewards:SetLocalPosition(Vector3.new(0,0,0))
            rewards:SetName("rewards")

            self:BindUIEvent ("City_CreateCity"..i.."/rewards/baoxiang_lv1_btn", UIEventType.Click, "OnClickTreasureNormal",i)--点击的城
            self:BindUIEvent ("City_CreateCity"..i.."/rewards/baoxiang_lv3_btn", UIEventType.Click, "OnClickTreasureHard",i)--点击的城
        end

        if not NeedNormal and not NeedHard then
            rewards:Destroy()
        end

        local Normal = rewards:FindChild("baoxiang_lv1_btn")
        local Hard = rewards:FindChild("baoxiang_lv3_btn")

        Normal:SetActive(NeedNormal)
        Hard:SetActive(NeedHard)

    end



end


function wnd_tuiguanClass:FillContent()
    self:TuiGuanDetail()
    self:Routine()
end

function wnd_tuiguanClass:GetMixed()
    return TuiGuanMixed
end

function wnd_tuiguanClass:Check__A__Hero()

end


function wnd_tuiguanClass:OurSquare(armySquareInfo,heroID)
    local TempHero = Player:GetHeroByID(heroID)

    if TempHero == nil then return true end 
    armySquareInfo:SetHXJ(TempHero:GetAttr(HeroAttrNames.XJ))
    armySquareInfo:SetHeroLevel(TempHero:GetAttr(HeroAttrNames.LV))
    armySquareInfo:SetSXJ(TempHero:GetAttr(HeroAttrNames.SXJ))

    local AHero = Player:GetAHeroinfoByID(heroID)
    local hp = 0--AHero:GetValue(AHeroinfos.hp)
    local Army = 0
    local b = Player:GetAHeroinfos()
    local eachFunc = function(syncObj)
        if tonumber(syncObj:GetValue(AHeroinfos.id)) == tonumber(heroID) then
            hp = syncObj:GetValue(AHeroinfos.hp)
        end
    end
    b:ForeachAHeroinfos(eachFunc)
   
    --armySquareInfo:SetHP(10)
    armySquareInfo:SetHP(hp)

    local HpInt = tonumber( hp )

    if HpInt == 0 then
        return true
    else
        return false
    end
    --armySquareInfo:SetHP(11)
    --
end

function wnd_tuiguanClass:CreateMySquare(fid,heroID,bingCount)
    --print("wnd_tuiguanClass:CreateMySquare Fid:",fid,"HeroID:",heroID)
    local TempHero = Player:GetHeroByID(heroID)
    if TempHero == nil then return nil end

    local armySquareInfo = ArmySquareInfo.new()--创建方阵实例
    armySquareInfo:SetFlag(ArmyFlag.Attacker)
    armySquareInfo:SetFID(fid)
    armySquareInfo:SetHeroID(heroID)
    armySquareInfo:SetSoldiersCount(bingCount)

    local wujuID = TempHero:GetAttr(HeroAttrNames.WuID)
    local fangjuID = TempHero:GetAttr(HeroAttrNames.FangID)
    
    local ResultEquip = {}
    local wuqi = Equip.new()--创建武器实例
    if wujuID ~= "" then 
        local wujuShort = wnd_heroinfo:ID_DataID(wujuID)
        wuqi:SetStaticID(wujuShort)--设置装备数据ID
        local st = wnd_heroinfo:GetXilianNumZXY(wujuID)
        wuqi:SetXilianST(st)--设置装备洗练状态
        table.insert(ResultEquip,wuqi)
    end
    --装备队列
    local fangju = Equip.new()--创建防具实例
    if fangjuID ~= "" then 
        local fangjuShort = wnd_heroinfo:ID_DataID(fangjuID)
        fangju:SetStaticID(fangjuShort)--设置防具数据ID
        local st = wnd_heroinfo:GetXilianNumZXY(fangjuID)
        fangju:SetXilianST(st)--设置防具洗练状态
        table.insert(ResultEquip,fangju)
    end
    armySquareInfo:SetEquips(ResultEquip)--装备队列放入军队方阵中
    local heroInfo = SData_Hero.GetHero(heroID)
    local skills = heroInfo:Skills()--获得技能队列
    local skillLevels = {}--技能等级索引
    local i = 1
    for _,skillID in pairs(skills) do 
        local skillIdx = heroInfo:GetSkillIndex(skillID)+1--获取技能索引号,返回的是从0开始的，转换为从1开始的索引
        skillLevels[skillIdx] = 1--给指定技能设置等级，这里设置1级
        skillLevels[skillIdx] = TempHero:GetSkillLevelByIndex(i)--给指定技能设置等级，这里设置1级
        i = i + 1
    end  
    armySquareInfo:SetSkillLevels(skillLevels)--技能等级队列放入军队方阵中
    --###   第二部分信息  ###
    local isHP0 = self:OurSquare(armySquareInfo,heroID)
    if isHP0 then
        return nil
    end

    return armySquareInfo
end

function wnd_tuiguanClass:CreateOtherSquare(fid,heroID,bingCount)
    if heroID == nil or heroID == -1 then 
        return nil
    end
    local heroInfo = SData_Hero.GetHero(heroID)
    if heroInfo == nil then 
        return nil
    end

    local HP = self:GetEnemyHP(heroID)
    if HP == 0 then
        print("wnd_tuiguanClass:CreateOtherSquare ======================= ",HP,"ID:",heroID)
        return nil
    end

    local armySquareInfo = ArmySquareInfo.new()--创建方阵实例
    armySquareInfo:SetFlag(ArmyFlag.Defender)
    armySquareInfo:SetFID(fid)
    armySquareInfo:SetHeroID(heroID)
    
    armySquareInfo:SetEquips({})--装备队列放入军队方阵中
    
    local LV = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterLv,TuiGuanMixed.ReadyFightMission)
    armySquareInfo:SetHeroLevel(LV)
    armySquareInfo:SetSXJ(1)
    local heroInfo = SData_Hero.GetHero(heroID)
    local skills = heroInfo:Skills()--获得技能队列
    local skillLevels = {}--技能等级索引
    local i = 1
    for _,skillID in pairs(skills) do 
        skillLevels[i] = LV--给指定技能设置等级，这里设置表里怪的等级
        i = i + 1
    end  
    
    armySquareInfo:SetSkillLevels(skillLevels)--技能等级队列放入军队方阵中
    local TempHero = wnd_fightwin:GetHero(0,heroID)
    
    
    
    local Army = self:GetEnemyArmy(heroID)
    armySquareInfo:SetSoldiersCount(Army)
    armySquareInfo:SetHP(HP) 
    
    --armySquareInfo:SetHXJ(TempHero.XJ)

    return armySquareInfo
end
function wnd_tuiguanClass:GetHerosInfo()
    
    local Formation = Player:GetFrms()
    local  Info = {}
    local id 
	for k,v in pairs (Formation) do
        if k == FrmsType.PuTong then 
		    id = tonumber( v:GetAttr(FrmsNames.ZhenID) )
	        Info = v:GetAttr(FrmsNames.ZhenPos)
        end
	end
    local MyHeros = {}
    MyHeros[1]= 0
    MyHeros[2]= 0
    MyHeros[3]= 0
    MyHeros[4]= 0
    MyHeros[5]= 0
    local Infos_1 = string.split(Info,',')
    for k,v in pairs (Infos_1) do
        local Infos_2 = string.split(v,':')
        local Pos = tonumber( Infos_2[1] )
        local Hero = tonumber( Infos_2[2] )
        MyHeros[Pos] = Hero
    end
    --对方阵型
    local EnemyHeros = {}
    EnemyHeros[1] = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID1,TuiGuanMixed.ReadyFightMission)
    EnemyHeros[2] = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID2,TuiGuanMixed.ReadyFightMission)
    EnemyHeros[3] = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID3,TuiGuanMixed.ReadyFightMission)
    EnemyHeros[4] = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID4,TuiGuanMixed.ReadyFightMission)
    EnemyHeros[5] = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID5,TuiGuanMixed.ReadyFightMission)
    return MyHeros,EnemyHeros,id
end

function wnd_tuiguanClass:IsJunLingEnough()
    local Cost = tonumber( sdata_keyvalue:GetV(sdata_keyvalue.I_LingXiaohao,1) )
    print("wnd_tuiguanClass:IsJunLingEnough",Cost)
    return self.JunLing >= Cost
end

function wnd_tuiguanClass:PerformanceHero(fid,Flag)

    local MissionID = tonumber( ifv(Flag == ArmyFlag.Defender,102,101) )
    local heroID = sdata_MissionMonster:GetHero(fid,MissionID)
    if heroID == -1 then 
        return nil
    end

    local armySquareInfo = ArmySquareInfo.new()--创建方阵实例
    armySquareInfo:SetFlag(Flag)
    armySquareInfo:SetFID(fid)
    armySquareInfo:SetHeroID(heroID)
    
    local ArmyCount = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterArmyNo,MissionID)
    armySquareInfo:SetSoldiersCount(ArmyCount)
    armySquareInfo:SetEquips({})--装备队列放入军队方阵中
    
    local LV = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterLv,MissionID)
    armySquareInfo:SetHeroLevel(LV)
    armySquareInfo:SetSXJ(1)
    armySquareInfo:SetHP(-1) 
    print("wnd_tuiguanClass:PerformanceHero",fid,heroID,ArmyCount,LV)
    local heroInfo = SData_Hero.GetHero(heroID)
    local skills = heroInfo:Skills()--获得技能队列
    local skillLevels = {}--技能等级索引
    --local i = 1
    --for _,skillID in pairs(skills) do 
    --    skillLevels[i] = LV
    --    i = i + 1
    --end  
    for i = 1, 6 do 
        skillLevels[i] = 1
    end
    armySquareInfo:SetSkillLevels(skillLevels)--技能等级队列放入军队方阵中
    return armySquareInfo
end



function wnd_tuiguanClass:Performance()

    print("wnd_tuiguanClass:Performance")
    local BattleParmaInstance =  FightParameter.new()--创建战斗参数对象
    local LeftZhen = tonumber( sdata_MissionMonster:GetV(sdata_MissionMonster.I_ZhenfaID,101) )
    BattleParmaInstance:SetLeftZhenfaID(tonumber( LeftZhen ))--设置左阵法
    local RightZhen = tonumber( sdata_MissionMonster:GetV(sdata_MissionMonster.I_ZhenfaID,102) )
    BattleParmaInstance:SetRightZhenfaID(tonumber( RightZhen))--设置右阵法
    local MapID = tonumber( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MapID,101) )
    BattleParmaInstance:SetSceneID(MapID)--设置场景ID
    local Music = tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_Music,101) )
    BattleParmaInstance:SetMusic(Music)--设置背景音
    print("wnd_tuiguanClass:Performance2")
    local SquareList = {}
    table.insert(SquareList,self:PerformanceHero(1,ArmyFlag.Attacker))
    table.insert(SquareList,self:PerformanceHero(2,ArmyFlag.Attacker))
    table.insert(SquareList,self:PerformanceHero(3,ArmyFlag.Attacker))
    table.insert(SquareList,self:PerformanceHero(4,ArmyFlag.Attacker))
    table.insert(SquareList,self:PerformanceHero(5,ArmyFlag.Attacker))
    print("wnd_tuiguanClass:Performance3")
    table.insert(SquareList,self:PerformanceHero(1,ArmyFlag.Defender))
    table.insert(SquareList,self:PerformanceHero(2,ArmyFlag.Defender))
    table.insert(SquareList,self:PerformanceHero(3,ArmyFlag.Defender))
    table.insert(SquareList,self:PerformanceHero(4,ArmyFlag.Defender))
    table.insert(SquareList,self:PerformanceHero(5,ArmyFlag.Defender))
    print("wnd_tuiguanClass:Performance4",SquareList)
    BattleParmaInstance:SetSquares(SquareList)--阵容队列放进战斗参数
    Wnd.HideAll()--隐藏所有界面
    Battlefield.StartFight(BattleParmaInstance)
    local LHeroStr = tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID1,101) )
    LHeroStr = LHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID2,101) )
    LHeroStr = LHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID3,101) )
    LHeroStr = LHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID4,101) )
    LHeroStr = LHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID5,101) )
    local RHeroStr = tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID1,102) )
    RHeroStr = RHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID2,102) )
    RHeroStr = RHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID3,102) )
    RHeroStr = RHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID4,102) )
    RHeroStr = RHeroStr..","..tostring( sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterHeroID5,102) )
    debug.LogError("==1=="..LHeroStr);
    debug.LogError("==2=="..RHeroStr);
    QY2LessonManager.SetReMainHero(LHeroStr,RHeroStr);
end
function wnd_tuiguanClass:TestEnterFight()
    print("wnd_tuiguanClass:TestEnterFight")
    if self:IsJunLingEnough() == false then
        self:JunLingBtn()
        wnd_buzheng:MaskLu(false)
        return 
    end
    local ContentPosition = self.content:GetLocalPosition()
    self.ContentZ = ContentPosition.z
    --己方阵型
    local MyHeros ={}
    --对方阵型
    local EnemyHeros = {}
    --己方ID
    local MyFormationID
    --敌方ID
    local EnemyFormationID = sdata_MissionMonster:GetV(sdata_MissionMonster.I_ZhenfaID,TuiGuanMixed.ReadyFightMission)
    MyHeros,EnemyHeros,MyFormationID = self:GetHerosInfo()
    --阵法名
    local MyFormationStruct = SData_Zhenfa.Get(MyFormationID)
    local EnemyFormationStruct = SData_Zhenfa.Get(EnemyFormationID)
    local MyFormationName = MyFormationStruct:ZhenfaBuzhi(1)
    local EnemyFormationName = EnemyFormationStruct:ZhenfaBuzhi(1)

    --场景名
    local MapID = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MapID,TuiGuanMixed.ReadyFightMission)
    --音乐名
    local Sound = sdata_MissionMonster:GetV(sdata_MissionMonster.I_Music,TuiGuanMixed.ReadyFightMission)
    --对方兵数量
    local EnemyArmyCount = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterArmyNo,TuiGuanMixed.ReadyFightMission)
    --我方士兵数量
    local PlayerLV = tonumber( Player:GetAttr(PlayerAttrNames.Level) )
    local MyArmyCount = sdata_KeyValueMath:GetV(sdata_KeyValueMath.I_ArmyNo,PlayerLV)
    --怪物等級
    self.EnemyLV = sdata_MissionMonster:GetV(sdata_MissionMonster.I_MonsterLv,TuiGuanMixed.ReadyFightMission)

    
    WndJumpManage:CancelAllJumps()--清空所有 跳转

    local param =  FightParameter.new()--创建战斗参数对象
    param:SetLeftZhenfaID(tonumber( MyFormationID ))--设置左阵法
    param:SetRightZhenfaID(tonumber( EnemyFormationID))--设置右阵法
    param:SetSceneID(MapID)--设置场景ID
    param:SetMusic(Sound)--设置背景音
    --param:SetMusic("justforfun")
    print("wnd_tuiguanClass:TestEnterFight1")
    local SquareList = {}
    for i = 1, 5 do
        local ArmyCount = tonumber( sdata_KeyValueMath:GetV(sdata_KeyValueMath.I_ArmyNo,PlayerLV) )
        local temp = self:CreateMySquare(i,MyHeros[i],ArmyCount)
        if temp ~= nil then 
            table.insert(SquareList,temp)
        end
    end
    print("wnd_tuiguanClass:TestEnterFight2")
    for i = 1, 5 do
        local temp = self:CreateOtherSquare(i,EnemyHeros[i],EnemyArmyCount)
        if temp ~= nil then 
            table.insert(SquareList,temp)
        end
    end
    print("wnd_tuiguanClass:TestEnterFight3")
    param:SetSquares(SquareList)--阵容队列放进战斗参数
    --将配置好的参数传递给战役，并启动战斗
	
    if  sdata_MissionMonster:GetV(sdata_MissionMonster.I_LineType,TuiGuanMixed.ReadyFightMission) == 2 or  sdata_MissionMonster:GetV(sdata_MissionMonster.I_LineType,TuiGuanMixed.ReadyFightMission) == 4 then
		Battlefield.StartFight(param,self,self.showJUqing)
	else
		Battlefield.StartFight(param)
	end
    self.FightType = "NormalFight"
    Wnd.HideAll()--隐藏所有界面
    print("wnd_tuiguanClass:TestEnterFight4")
    --Poptip.PopMsg("进入战斗！！！",Color.red)
end

function wnd_tuiguanClass:showJUqing()
--与策划约定2为战前
	wnd_GuankaJuqing:CurrentGuan(TuiGuanMixed.ReadyFightMission,2)
	wnd_GuankaJuqing:Show()
end

function wnd_tuiguanClass:SyncFakeGK()
    print("wnd_tuiguanClass:SyncFakeGK",Player)
	self.isPerformance = tonumber( Player:GetAttr(PlayerAttrNames.Probie) )
    --self.isPerformance = 1
    print("wnd_tuiguanClass:SyncFakeGK1",self.isPerformance)
    if  self.isPerformance == 1 then 
        wnd_tuiguan:Show()
    else
        self:Performance()
    end
    print("wnd_tuiguanClass:SyncFakeGK End")
end

function wnd_tuiguanClass:AdjustReadyFightMission()
    local Next = sdata_MissionMonster:GetNext(TuiGuanMixed.ReadyFightMission)

    local isLast = sdata_MissionMonster:isLastMissionInCity(TuiGuanMixed.ReadyFightMission)
    if TuiGuanMixed.isWin == 1 then --赢了
        if isLast then --城最后一关
            wnd_readyfight:SetMission(0)
        else
            wnd_readyfight:SetMissionToNext()
        end
    else --输了

    end
        
end

function wnd_tuiguanClass:OnFightEnd(_Result)
    print("wnd_tuiguanClass:OnFightEnd isWin")
    BackgroundMusicManage.Stop(0.2)
	BackgroundMusicManage.Play("uisound","onlinemusic1",1)
    TuiGuanMixed.isWin = tonumber( ifv(_Result:IsWin(),"1","0") )
	if wnd_buzheng.t then
		wnd_fightwin:SetResult(_Result)
		self.bisWin = tonumber( ifv(_Result:IsWin(),"1","0") )
		self:network_suiji()
		 print("随机事件战斗结束:OnFightEnd isWin")
        return
	end


    if self.FightType == "TestJJC" then 
        Battlefield.Reset()
        wnd_tuiguan:Show()
        return
    end
    if self.isPerformance == 0 then 
        WndManage.Show("ui_prefight",0.5)
        self:SendPerformanceNetWork()
        return
    end

    --告诉新手指导当前关卡和战斗情况
    QY2LessonManager.SetQKWin(TuiGuanMixed.CurrentAttackMission,TuiGuanMixed.isWin+0);
    self:AdjustReadyFightMission()

    wnd_fightwin:SetResult(_Result)
    self.FightResult = _Result



    if  sdata_MissionMonster:GetV(sdata_MissionMonster.I_LineType,TuiGuanMixed.ReadyFightMission) == 3 or  sdata_MissionMonster:GetV(sdata_MissionMonster.I_LineType,TuiGuanMixed.ReadyFightMission) == 4 then
		wnd_GuankaJuqing:CurrentGuan(TuiGuanMixed.ReadyFightMission,3)--与策划约定2为战后
		wnd_GuankaJuqing:Show()		
	else
		self:SendEndGKNetWork()
	end
end
--随机怪物战斗返回结果通知服务器
function wnd_tuiguanClass:network_suiji()
	local jsonNM = QKJsonDoc.NewMap()	
    jsonNM:Add ("n","SJMFend")  
	jsonNM:Add ("id", wnd_randomEvents.sjinfo)
	jsonNM:Add ("isW", TuiGuanMixed.isWin)
	local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.Network_suiji)
end
function wnd_tuiguanClass:Network_suiji(jsonDoc)
	local num = tonumber (jsonDoc:GetValue("r"))

	wnd_fightwin:SetReblood(false)
    wnd_fightwin:SetWinState(self.bisWin)
    wnd_fightwin:SetJLList(jsonDoc)
    wnd_fightwin:Show()
	wnd_randomEvents:setMonsterJL(jsonDoc)
end
function wnd_tuiguanClass:OnCloudClick(quad)
   
    local proID = quad:ID();
    if(self:isProOpen(proID) == 2 and proID > Player:GetOpenProvinceID())then
       
        local jsonNM = QKJsonDoc.NewMap()	
        jsonNM:Add ("n","GKCloud")  
	    jsonNM:Add ("CRecall", proID)--当前出战英雄ID字符串
	    local loader = GameConn:CreateLoader(jsonNM,0) 
	    HttpLoaderEX.WaitRecall(loader,self,self.OpenProvince)
       
    end
end
--此函数是为了让动画走完，之后将碰撞盒去掉
function wnd_tuiguanClass:OpenProvince(jsonDoc)
 
    local Result = tonumber (jsonDoc:GetValue("r"))
    if(Result == 0)then

    --默然是同步数据先更新，此条消息后到，所以这里就用同步的数据
        local provinceID = Player:GetOpenProvinceID();
        if(provinceID > 1 and self.TuiGuanClouds[provinceID] ~= nil)then 
        
            local quad =  self.TuiGuanClouds[provinceID]:GetComponent(QKUIQuad.Name);
           
            quad:PlayAction();
            
            QKUIQuad.SetProID(provinceID);
            
            local sequencem = Sequence.new()

            sequencem:InsertCallback(1.0,self,self.ChangeCloudState);

        end
    end
     
end
function wnd_tuiguanClass:ChangeCloudState()
 
    local proID = Player:GetOpenProvinceID();
    if(self.TuiGuanClouds[proID] ~= nil)then
        self.TuiGuanClouds[proID] :SetActive(false);
        local quad =  self.TuiGuanClouds[proID]:GetComponent(QKUIQuad.Name);
        quad:SetColliderEnable(false);
        quad:SetOutLine(false);
  
    end

    self:SyncMission()
    self:UpdateProvince()
    self:UpdateCity()
    self:UpdateCurrentAttackFlag()
    self:UpdateNextCityFlag()
end
function wnd_tuiguanClass:UpdateCloud()

    local proID =  Player:GetOpenProvinceID();
    --print ("wnd_tuiguanClass:UpdateCloud ========= ProID:",proID)
    local eatchfunch = function (key,value)
        local itemObj = value
        if(itemObj == nil)then
            return;
        end
        local quad = itemObj:GetComponent(QKUIQuad.Name);
        if(quad ~= nil)then
            local curV = self:isProOpen(key)
            --print ("wnd_tuiguanClass:UpdateCloud ============= key"  ,key ,curV)
            if(curV == 2  and key > proID)then
                itemObj:SetActive(true);
                quad:SetColliderEnable(true);
                quad:SetOutLine(true);
            elseif(curV == 4 )then
                itemObj:SetActive(true);
                quad:SetColliderEnable(false);
                quad:SetOutLine(false);
            else
                itemObj:SetActive(false);
                quad:SetColliderEnable(false);
                quad:SetOutLine(false);
            end
        end
	end
	table.foreach(self.TuiGuanClouds,eatchfunch)
    self:SetProvinceCloud();

end
--主要用来设置底层的云层更新的
function wnd_tuiguanClass:SetProvinceCloud()
    local Province = Player:GetOpenProvinceID();
    QKUIQuad.SetProID(Province);
end
--获取服务器时间
function wnd_tuiguanClass:GetServerTime()
	local jsonNM = QKJsonDoc.NewMap()	
	jsonNM:Add("n","Gt") 
	local loader = GameConn:CreateLoader(jsonNM,0) 
	HttpLoaderEX.WaitRecall(loader,self,self.NM_ReGetServerTime)
end
function wnd_tuiguanClass:NM_ReGetServerTime(jsonDoc)
	local servertime  = tonumber(jsonDoc:GetValue("ST"))
	if self.bIsBuyhero then
		wnd_recruitHero:PlayerHeroData(servertime,self.IDhero)
        wnd_recruitHero:Show()
	else
		
		local list = Player:GetHHeros()
		local BT = list[1]:GetNumberAttr(HInfo.BT)
		local cha  = servertime-BT
		local LT = sdata_keyvalue:GetV(sdata_keyvalue.I_ZhaoxiangTime,1)-cha
		self.TimeCountCm:StartCountDown(LT)
	end
end
--7878
function wnd_tuiguanClass:callbackjianting()


end
--[[
function wnd_tuiguanClass:()
    print("wnd_tuiguanClass:")
end
--]]
return wnd_tuiguanClass.new
 
