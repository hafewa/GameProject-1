using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using UnityEngine;


/// <summary>
/// 英雄半身像
/// </summary>
[AddComponentMenu("QK/UI/UIHeroBanshen")]
[RequireComponent(typeof(UITexture))]
class UIHeroBanshen:MonoBehaviour
{

    public void Awake()
    {     
        m_Texture = GetComponent<UITexture>();
    }
    void OnDestroy()
    {
        ReleasePack();
    }

    //英雄ID
    public void SetIcon(int heroID,bool isZhuansheng)
    {
        m_SetID = heroID;
        m_SetIsZhuanshen = isZhuansheng; 
        if(!m_coDoing)
        {
            m_coDoing = true;

            //用monoex协程，组件被删了携程也会继续执行，防止资源装到一半时删除本组件，导致资源包一直占内存
            MonoEX.CoroutineManage.Single.StartCoroutine(coSetHeroID());
        } 
    }

    IEnumerator coSetHeroID()
    {
        yield return null;
        while (m_SetID>0)
        { 
            int heroid = m_SetID;
            bool isZhuanshen = m_SetIsZhuanshen;
            m_SetID = -1; 

            //先卸掉原来的资源
            ReleasePack();

            bool loading = true;

            //装入新的资源包
            string newPackName = SData_Hero.Get(heroid).HeroBanshen;
           
            PacketLoader loader = new PacketLoader();
            List<string> packNames = new List<string>(); packNames.Add(newPackName);
            loader.Start(
                PackType.Res,
                packNames,
                (isdone)=>{
                    loading = false;
                    ResourceRefManage.Single.AddRef(newPackName);//包引用数增加
                    m_HeroID = heroid;//设置当前英雄id

                    //从包中取出纹理
                    var pack = PacketManage.Single.GetPacket(newPackName);
                    if (pack == null){ Debug.LogError(string.Format("不存在的半身像包 [{0}] heroID:{1}", newPackName, heroid));}
                    var texture = pack.Load(newPackName + (isZhuanshen ? "_2" : "_1")) as Texture;
                    //if (m_Texture == null)
                    //{
                    //    m_Texture = GetComponent<UITexture>();
                    //}
                    //设置主纹理
                  
                    m_Texture.mainTexture = texture;
                }
            );

            while (loading) yield return null;//等待资源装载完成
        }

        if(gameObject==null)//组件已经被删除 
            ReleasePack(); 

        m_coDoing = false;
    }

    void ReleasePack()
    {
        if (m_HeroID <= 0) return;
        ResourceRefManage.Single.SubRef(SData_Hero.Get(m_HeroID).HeroBanshen);
        m_HeroID = 0;
    }


    int m_SetID = -1;
    bool m_SetIsZhuanshen = false;


    bool m_coDoing = false;
    UITexture m_Texture;
    int m_HeroID =0;
} 